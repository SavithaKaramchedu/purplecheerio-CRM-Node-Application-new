var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(k){var g=function(){};g.prototype=k;return new g};$jscomp.underscoreProtoCanBeSet=function(){var k={a:!0},g={};try{return g.__proto__=k,g.a}catch(m){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(k,g){k.__proto__=g;if(k.__proto__!==g)throw new TypeError(k+" is not extensible");return k}:null;
$jscomp.inherits=function(k,g){k.prototype=$jscomp.objectCreate(g.prototype);k.prototype.constructor=k;if($jscomp.setPrototypeOf){var m=$jscomp.setPrototypeOf;m(k,g)}else for(m in g)if("prototype"!=m)if(Object.defineProperties){var p=Object.getOwnPropertyDescriptor(g,m);p&&Object.defineProperty(k,m,p)}else k[m]=g[m];k.superClass_=g.prototype};$jscomp.owns=function(k,g){return Object.prototype.hasOwnProperty.call(k,g)};
$jscomp.assign="function"==typeof Object.assign?Object.assign:function(k,g){for(var m=1;m<arguments.length;m++){var p=arguments[m];if(p)for(var w in p)$jscomp.owns(p,w)&&(k[w]=p[w])}return k};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,g,m){k!=Array.prototype&&k!=Object.prototype&&(k[g]=m.value)};$jscomp.getGlobal=function(k){return"undefined"!=typeof window&&window===k?k:"undefined"!=typeof global&&null!=global?global:k};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(k,g,m,p){if(g){m=$jscomp.global;k=k.split(".");for(p=0;p<k.length-1;p++){var w=k[p];w in m||(m[w]={});m=m[w]}k=k[k.length-1];p=m[k];g=g(p);g!=p&&null!=g&&$jscomp.defineProperty(m,k,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Object.assign",function(k){return k||$jscomp.assign},"es6","es3");
(function(){function k(g,f){w[g]||(p[g]={exports:{},loaded:!1},w[g]=!0,0===g&&"function"===typeof require?require.main=p[0]:p[g].parent=p[f],m[g].call(this,p[g],p[g].exports),p[g].loaded=!0);return p[g].exports}function g(g){return require("path").resolve(__dirname+"/"+g+"/../")}var m={},p={},w={};m[0]=function(g,f){fs=require("fs");var m=k(1,0);f=require("commander");f.version("1.0").option("-s, --servicename <servicename>","servicename").option("-l, --list ","list system services").option("-t, --test ",
"test cipher").option("-i, --initoptions <initoptions>","application specific options see serviceconfigfile init.options").parse(process.argv);if(process.argv.slice(2).length)if(f.servicename){var r=f.servicename;f.initoptions&&console.log("initoptions="+f.initoptions);m.startsystemservice(r,JSON.parse(f.initoptions))}else{if(f.list)for(r in m=m.getsystemserviceconfig(),console.log(JSON.stringify(m,0,2)),m)console.log("service="+r+"\n  description="+m[r].description+"\n  url="+m[r].url+" security mode="+
m[r].security);f.test&&(require("crypto"),f=k(2,0),r=f.Cipher("whisper","hello world"),f=f.Decipher("whisper",r),console.log(f.toString("UTF8")))}else f.outputHelp();return g.exports};m[1]=function(m,f){function p(a,b,c){c=c.toLowerCase();var e=[];try{e=a.routes.filter(function(a,d){d=a.route;if("static"===a.type)x=d;else{var x=d.replace(/\/:[a-z0-9A-Z.%\-,;:()*?@'!]+/g,"/[a-z0-9A-Z.%\\-,;:()*?@'!]+");"/"==b[b.length-1]&&"/"!=d[d.length-1]&&(x+="\\/");"/"!=b[b.length-1]&&"/"==d[d.length-1]&&(b+="/");
x+="$"}if(0==b.search(new RegExp(x,"g"))&&(a.type.toLowerCase()==c||"static"==a.type.toLowerCase()&&"get"===c))throw e.push(a),e;})}catch(B){if("array"==typeof B)return B}return e[0]}function r(a,b,c){return a.routes.filter(function(a){return a.route==b&&a.type==c})[0]}function O(d,f,l){f&&(q=f);this.use(G.json());this.use(G.urlencoded({extended:!0}));this.use(A.static(a.join(g("index.js"),"templates")));this.use("/service",A.static(a.join(g("index.js"),"templates")));this.use("/samples",A.static(a.join(g("index.js"),
"templates")));this.use("/dashboard",A.static(a.join(g("index.js"),"templates")));this.use("/css",A.static(a.join(g("index.js"),"templates")));this.use("/images",A.static(a.join(g("index.js"),"templates")));this.use("/css/bootstrap.css.map/",A.static(a.join(g("index.js"),"templates")));this.use("/documentation",function(a,c){a=b.readFileSync(g("index.js")+"/templates/documentation.html","utf8");c.set("Content-Type","text/html");a=E(a);c.send(a)});this.use("/test",function(a,b){I(a,b,!0,null,null)});
this.use("/testhttp",function(a,b){I(a,b,!1,null,null)});this.get("/routelist/:servicename",function(c,d){if(c.params.servicename){var h=q.services[c.params.servicename];if(h)if(h&&h.configfilepath){var x=g("index.js");e&&(x=e);h=a.resolve(x,h.configfilepath);b.existsSync(h)?(c=require(h),d.json(c.routes)):d.status(404).send("service="+c.params.servicename+" not deployed")}else c="servicename="+c.params.servicename+" not found",console.log(c),d.status(404).send(c);else console.log("servicename="+
c.params.servicename+" not found in serviceconfig.json")}else d.status(422).send("servicename is required")});this.use("/servicelist",function(c,e){c=b.readFileSync(g("index.js")+"/templates/services.html","utf8");var d="",h="",x=!1;q.services.hasOwnProperty("keymgr")&&(x=!0);var l="";x||(l="There are system services available. To see the list of services, please run the keymgr service. For an example of how to run keymgr system service, please see corresponding usage in runsampleservice.bash in examples directory.");
for(var t in q.services){var f="",n=q.services[t];if(x){var u=a.resolve(g("index.js"),n.configfilepath);if(!b.existsSync(u)){console.log("service="+t+" not deployed configpath="+u+" does not exist");continue}}d+="<li><a class='scrollto' href='#"+t+"'>"+t+"</a></li>";f+="<p><b>"+n.description+"</b></p><br/>";f+="<p><b>Documentation: </b><a class='btn-purple' href=/service/"+t+">"+t+"</a></p>";if(n.pathsamples){var B=null;u=a.resolve(g("index.js"),n.pathsamples+"/examples.json");try{B=require(u)}catch(S){console.log("samples for "+
u+" do not exist diname="+g("index.js"))}B&&(f+="<p><b>Examples:</b><a class='btn-purple' href=/samples/"+t+">"+t+"</a></p>")}f+="<br/>";x&&(f+="For an example of how to run "+t+" system service, please see corresponding usage in runsampleservice.bash in examples directory.",f+="<br/>",f+="<p><b>Launch command: </b>node ../purplesky/purplerouteservice.js -s "+t,n.init&&n.init.optionschema&&(f+=" -i &lt;option json&gt;</p>",f+="<p>&lt;option json&gt; needs to conform to this schema:</p>",f+="<pre>"+
JSON.stringify(n.init.optionschema,0,2)+"</pre>",n.init.options&&(f+="<p>default &lt;option json&gt;:</p>",f+="<pre>"+JSON.stringify(n.init.options,0,2)+"</pre>")));h+='<section id="REPLservicename" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",f).replace(/REPLservicename/g,t)}c=c.replace("REPLNotice",l).replace("REPLservicelist",d).replace("REPLsectioncontent",h);c=E(c);e.send(c)});
this.get("/routeinfo/:servicename",function(b,c){if(b.params.servicename)if(b.query.r)if(b.query.m){var d=q.services[b.params.servicename];if(d){var h=g("index.js");e&&(h=e);d=require(a.resolve(h,d.configfilepath));(b=r(d,b.query.r,b.query.m))||(b=d.routes[0]);b.configured?c.json(b):c.status(422).send("route not configured")}else b="servicename="+b.params.servicename+" not found in serviceconfig.json",console.log(b),c.status(403).send(b)}else c.status(422).send("method is required");else c.status(422).send("routename is required");
else c.status(422).send("servicename is required")});this.use("/service/:servicename",function(d,h){a:if(d=d.params.servicename){var l=q.services[d];if(l)if(l.configfilepath){var t=b.readFileSync(g("index.js")+"/templates/routes.html","utf8");t=t.replace("REPLservicedescription",l.description);var f="",x="",n=g("index.js");e&&(n=e);try{var u=require(a.resolve(n,l.configfilepath))}catch(N){console.log(N);h.status(422).send(N);break a}for(var B in u.routes)if(l=u.routes[B],l.configured){n="";n+="<h6><pre>"+
l.description+"</pre></h6>";n+="<h6>method="+l.type+"</h6>";l.paramschema&&(n+="<br><pre>parameter="+JSON.stringify(l.paramschema,0,2)+"</pre>");l.bodyschema&&(n+="<br><pre>payload="+JSON.stringify(l.bodyschema,0,2)+"</pre>");l.responseschema&&(n+="<br><pre>returnValue="+JSON.stringify(l.responseschema,0,2)+"</pre>");if(l.examples&&Array.isArray(l.examples)&&0<l.examples.length){n+="<br><h6>examples:</h6><pre>";for(var y in l.examples)0<y&&(n+="<br>"),l.examples[y].param&&(n+="params="+c(l.examples[y].param)),
l.examples[y].payload&&(n+="payload="+JSON.stringify(l.examples[y].payload,0,2));n+="</pre>"}f+="<li><a class='scrollto' href='#"+l.route+"'>"+l.route+"</a></li>";x+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",n).replace(/REPLroutename/g,l.route)}t=t.replace(/REPLservice/g,d).replace("REPLroutelist",f).replace("REPLsectioncontent",x).replace(/REPLHeader/,
"Documentation for the service").replace(/REPLSectionHeader/g,"API Routes");t=E(t);h.send(t)}else u="servicename="+d+" has no configfilepath",console.log(u),h.status(422).send(u);else u="servicename="+d+" not found in serviceconfig.json",console.log(u),h.status(422).send(u)}else h.status(422).send("servicename is required")});this.use("/samples/:servicename",function(c,e){if(c=c.params.servicename){var d=q.services[c];if(!d)console.log("servicename="+c+" not found in serviceconfig.json");else if(d.pathsamples){var h=
null,l=a.resolve(g("index.js"),d.pathsamples+"/examples.json");try{h=require(l)}catch(T){console.log("samples for "+l+" do not exist")}l=b.readFileSync(g("index.js")+"/templates/routes.html","utf8");l=l.replace("REPLservicedescription",d.description);var t="",n="";if(h)for(var f in h.Samples){var u=h.Samples[f],x="";x+="<h6><pre>"+u.description+"</pre></h6>";for(var B in u.code){var y=b.readFileSync(a.resolve(g("index.js"),d.pathsamples+"/"+u.code[B]),"utf8"),k="code";u.code[B].search(".sh")==u.code[B].length-
3&&(k="bashcode");x=u.code[B].search(".html")==u.code[B].length-5?x+("<div>"+y+"</div>"):x+("<pre class='"+k+"'>"+y+"</pre>")}t+="<li><a class='scrollto' href='#"+f+"'>"+f+"</a></li>";n+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",x).replace(/REPLroutename/g,f)}l=l.replace(/REPLservice/g,c).replace("REPLroutelist",t).replace("REPLsectioncontent",n).replace(/REPLHeader/,
"Sample code for the service").replace(/REPLSectionHeader/g,"Examples");l=E(l);e.send(l)}}else e.status(422).send("servicename is required")});this.use("/testhttpapi",function(a,b){a:{var c={},e={req:a,res:b,fService:!1};if(a.body.method){a.body.method=a.body.method.toLowerCase();var d={security:"accesskey"};d.Authorization=a.body.auth;d.Date=a.body.date;switch(a.body.method){case "post":try{""!==a.body.payload&&(c=JSON.parse(a.body.payload))}catch(Q){b.json({error:"payload is not proper json"});
break a}v.PostPutHttp("POST",d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),z,e);break;case "put":try{c=JSON.parse(a.body.payload)}catch(Q){b.json({error:"payload is not proper json"});break a}v.PostPutHttp("PUT",null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),z,e);break;case "get":v.GetHttpProper(d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),z,e);break;case "delete":v.DeleteHttp(d,null,a.body.protocol,
a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),z,e)}}else b.send("error - method missing in the form")}});this.use("/testapi",function(a,b){"save"===a.body.action?b.json("Saved"):C(a,b,f,z,{req:a,res:b,fService:!0})});this.validatesecurekey(d,f);this.get("/logoutbasic",function(a,b){switch(q.services[d].security){case "basic":b.status(401).send("Logged out");break;default:b.status(404).send("logoutbasic command available only when security is basic")}});var h=q.services[d];this.BodyValidate(h.configfilepath);
if(h.init&&"object"==typeof h.init&&h.init.class&&h.init.function){var n=require(a.resolve(g("index.js"),h.init.class)),u=null;l&&(u=l);h.init.options&&!u&&(u=h.init.options);if(h.init.optionschema&&(l=v.ValidateSchemaErrorObject(u,h.init.optionschema))){console.error("options do not conform to schema error="+l);return}n[h.init.function](u)}}function w(b){var c=g("index.js");e&&(c=e);var d=require(a.resolve(c,b));this.post("/*",function(a,b,c){var e=p(d,a.path,a.method);e?v.ParamValidate(a,b,e,d.definitions)&&
v.BodyValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.put("/*",function(a,b,c){var e=p(d,a.path,a.method);e?v.ParamValidate(a,b,e,d.definitions)&&v.BodyValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.get("/*",function(a,b,c){var e=p(d,a.path,a.method);e?v.ParamValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.delete("/*",function(a,b,c){var e=p(d,a.path,
a.method);e?v.ParamValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.use(function(a,b,c){var e=b.send;b.send=function(c){var h=p(d,a.path,a.method),l=null;h&&h.responseschema&&(d.definitions&&(h.responseschema.definitions=h.responseschema.definitions?Object.assign(h.responseschema.definitions,definitions):d.definitions),l=v.ValidateSchemaErrorObject(JSON.parse(c),h.responseschema));l&&(arguments[0]=JSON.stringify({error:l}),b.status(422));e.apply(b,
arguments)};c()})}function J(a,b,c){try{JSON.parse(c)}catch(t){}200!=b?a.res.status(b).json(JSON.stringify(c)):a.next()}function D(a,b){this.use(function(b,c,e){switch(q.services[a].security){case "appkey":var d=v.ServiceKeyName(a);if(!b.headers[d]||b.headers[d]!==q.services[a].key){b="invalid key to service="+d+" value="+b.headers[d];c.status(401).send(b);return}break;case "basic":d=null;b.headers&&(d=b.headers.authorization);if(!d){c.set("WWW-Authenticate",'Basic realm="User Visible Realm"');c.status(401).send("Authorization header missing");
return}d=d.search(/basic /i);if(0!=d)return c.set("WWW-Authenticate",'Basic realm="User Visible Realm"'),Error(401,"basic authorization header needs to start with [basic base64 encoded acckey:clientkey]");case "accesskey":if("accesskey"===q.services[a].security&&(d=null,b.headers&&(d=b.headers.authorization),d||c.status(401).send("Authorization header missing"),d=d.search(/hmac /i),0!=d))return Error(401,"hmac authorization header needs hmac encoded string");e={req:b,res:c,next:e};d={body:{}};d.body.payload=
JSON.stringify({headers:b.headers,servicename:a});d.body.service="keymgr";d.body.method="post";d.body.routena="/grants/check";C(d,c,null,J,e);return}e()})}function E(a){if(q.services.hasOwnProperty("keymgr"))var b="/images/favicon.png",c="/imagesfavicon.png",d="https://www.purplecheer.io",e="PurpleCheerio";else c=b="/images/sample.png",d="/documentation",e="SampleService";q.about&&(q.about.faviconurl&&(b=q.about.faviconurl),q.about.imageurl&&(c=q.about.imageurl),q.about.url&&(d=q.about.url),q.about.name&&
(e=q.about.name));a=a.replace(/REPLFavIcon/g,b);return a.replace("REPLLogo",'<h1 style="background-color:#d8b2d880"><a href="'+d+'"><img src="'+c+'" style="height:32px" />'+e+"</a></h1>")}function I(c,d,e,f,n){var h=e?b.readFileSync(g("index.js")+"/templates/testform.html","utf8"):b.readFileSync(g("index.js")+"/templates/testrest.html","utf8");d.set("Content-Type","text/html");if(e){e="";var l=null;n&&(l=c.body.service);var t=q.services.hasOwnProperty("keymgr")?!0:!1;for(m in q.services){var y=q.services[m];
if(t){var k=a.resolve(g("index.js"),y.configfilepath);if(!b.existsSync(k)){console.log("service="+m+" not deployed configpath="+k+" does not exist");continue}}e+="<option class='btn-info form-control' ";l==m&&(e+="selected ");e+="value="+y.security+"@@@"+m;e+=">"+m+"</option>"}h=h.replace(/REPLservicelist/g,e);var m="";c.body.route&&(m="<input id='rname' type='text' style='display:none' value='"+c.body.route+"' /><input id='rtype' type='text' style='display:none' value='"+c.body.method+"' /><input id='rpayload' type='text' style='display:none' value='"+
c.body.payload+"' />");h=h.replace(/REPLRoute/,m)}n?(c='<h2 class="title">Response</h2>',200!=f&&(c+='<h6 style="color:#800000">status='+f+"</h4>"),n=c+"<pre>"+n+"</pre>"):n="";h=h.replace("REPLExtra",n);h=E(h);d.send(h)}function z(a,b,c){try{var d=JSON.parse(c)}catch(B){d={data:c}}a.res.headerSent||I(a.req,a.res,a.fService,b,JSON.stringify(d,0,2))}function C(a,b,c,d,e){c&&"object"===typeof c?c=c.services[a.body.service]:(c=g("index.js")+"/deploy/lib/serviceconfig.json",c=v.GetServiceConfig(c,a.body.service));
y&&y.dnsservicename&&"localhost"==c.hostname&&(c.hostname=a.body.service,console.log(c.hostname));var n={},f=null,h=null;switch(c.security){case "basic":case "accesskey":f={};f.security=c.security;f.nonce=R++;f.acckey=a.body.acckey;f.secret=a.body.secretna;break;case "appkey":h=a.body.appkey?v.MakeKeyServiceAndKeyValue(a.body.service,a.body.appkey):v.MakeKeyServiceAndKeyValue(a.body.service,c.key)}switch(a.body.method){case "post":try{""!==a.body.payload&&(n=JSON.parse(a.body.payload))}catch(P){b.json({error:"payload is not proper json"});
break}v.PostPutHttp("POST",f,h,c.protocol,c.hostname,a.body.routena,c.port,JSON.stringify(n),d,e);break;case "put":try{""!==a.body.payload&&(n=JSON.parse(a.body.payload))}catch(P){b.json({error:"payload is not proper json"});break}v.PostPutHttp("PUT",f,h,c.protocol,c.hostname,a.body.routena,c.port,JSON.stringify(n),d,e);break;case "static":case "get":v.GetHttpProper(f,h,c.protocol,c.hostname,a.body.routena,c.port,"",d,e);break;case "delete":v.DeleteHttp(f,h,c.protocol,c.hostname,a.body.routena,c.port,
"",d,e)}}function M(a,c){this.startservice(a,null,null,c)}function F(c,d,f,n){var h=null,l=g("index.js");d&&(h=require(a.resolve(d,f)),require(a.resolve(d,h.services[c].configfilepath)),l=d);f||(f="./deploy/lib/serviceconfig.json");e=d;this.initialize(c,h,n);h&&(q=h);this.setuproutes(l,q.services[c].configfilepath);d=q.services[c];var y=d.port;f=a.resolve(l,f);d.key=v.EstablishKey(f,c);d.certPath?(c=a.resolve(l,"./"+d.certPath+".key"),l=a.resolve(l,"./"+d.certPath+".crt"),l={key:b.readFileSync(c),
cert:b.readFileSync(l)},K.createServer(l,this).listen(y,function(){console.log("Securely listening on port "+y)})):this.listen(y,function(){console.log("Listening on port "+y)})}function L(c,b){b=require(a.resolve(c,b));for(var d in b.routes){var e=b.routes[d];if(e.configured){var f=a.resolve(c,e.routeclass);"static"===e.type?this.use(e.route,A.static(f)):(f=require(f),this[e.type](e.route,f[e.routefunction]))}}}var A=require("express"),G=require("body-parser"),q=require("./deploy/lib/serviceconfig.json"),
v=k(2,1),K=require("https"),b=require("fs"),a=require("path");require("util");k(3,1);var c=require("htmlencode").htmlEncode,e=null;try{var d=a.resolve(g("index.js"),"./lib/deploy.json");console.log(d);var n=b.readFileSync(d,"UTF8"),y=JSON.parse(n)}catch(h){"ENOENT"!=h.code&&console.log(h.code+" - "+h.message)}var R=17986;f=function(){var a=A.call(this)||this;a.initialize=O;a.startservice=F;a.startsystemservice=M;a.setuproutes=L;a.validatesecurekey=D;a.BodyValidate=w;return a};$jscomp.inherits(f,A);
f=new f;m.exports=f;return m.exports};m[2]=function(m,f){function p(b,a){b=z.createHmac("sha256",b);b.update(a);return b.digest("hex")}function r(b,a){var c=k(3,2);if(b.secret&&b.acckey){if("accesskey"===b.security){var e=new Date,d=b.acckey+":"+b.nonce;a.Authorization="hmac "+d+":"+c.Sign(b.secret,d+":"+e);a.Date=e;return}if("basic"===b.security){c=Buffer.from(b.acckey+":"+b.secret).toString("base64");a.Authorization="basic "+c;return}}b.Authorization?(a.Authorization=b.Authorization,c=a.Authorization.indexOf("hmac "),
0!=c?(c=a.Authorization.search(/basic /i),0!==c&&console.log("badly formed authorization string - needs to start with hmac")):(c=a.Authorization.slice(c+5),c.split(":"),a.Date=b.Date)):console.log("missing authorization string")}function w(b){if(!b)return null;var a="",c;for(c in b)"object"===typeof b[c]?(""!=a&&(a+="&"),a+=c+"="+JSON.stringify(b[c])):"array"!==typeof b[c]&&(""!=a&&(a+="&"),a+=c+"="+b[c]);return a}var H=require("http"),J=require("https"),D=require("fs"),E=require("path"),I=require("querystring"),
z=require("crypto"),C=require("jsonschema").Validator;f.Cipher=function(b,a){var c=z.randomBytes(16).toString("hex").slice(0,16),e=z.createHash("sha256").update(b).digest("hex");e=e.slice(0,32);a=z.createCipheriv("aes-256-ctr",e,c).update(a).toString("hex");b=p(b,a);return c+":::"+a+":::"+b};f.Decipher=function(b,a){var c=a.split(":::");a=c[0];var e=c[2],d=p(b,c[1]);if(e!=d)return null;c=new Buffer(c[1],"hex");b=z.createHash("sha256").update(b).digest("hex");b=b.slice(0,32);return z.createDecipheriv("aes-256-ctr",
b,a).update(c)};f.ValidateSchemaErrorObject=function(b,a){b=(new C).validate(b,a);if(b.errors.length){a="";for(var c in b.errors)a+=b.errors[c].stack+" ";return a}return null};f.ValidateSchema=function(b,a,c,e){return(b=this.ValidateSchemaErrorObject(b,a))?(e.status(422).json({errors:b}),!1):!0};f.BodyValidate=function(b,a,c,e){return c&&c.bodyschema?(e&&(c.bodyschema.definitions=c.bodyschema.definitions?Object.assign(c.bodyschema.definitions,e):e),this.ValidateSchema(b.body,c.bodyschema,b,a)):!0};
f.ParamValidate=function(b,a,c,e){if(c&&c.paramschema){var d=b.params[0],f=c.route;"/"==f.slice(0,1)&&(f=f.slice(1));"/"==d.slice(0,1)&&(d=d.slice(1));"/"==f.slice(-1)&&(f=f.slice(0,-1));"/"==d.slice(-1)&&(d=d.slice(0,-1));for(var g={};""!=f;){var k=!1;":"==f.slice(0,1)&&(k=!0,f=f.slice(1));var h=f.search("/"),m=d.search("/");if(0<=h){var l=f.slice(0,h);f=f.slice(h+1);var t=d.slice(0,m);d=d.slice(m+1)}else l=f.slice(0),f="",t=d.slice(0),d="";k&&(k=Number(t),isNaN(k)?g[l]=t:g[l]=k)}e&&(c.paramschema.definitions=
c.paramschema.definitions?Object.assign(c.paramschema.definitions,e):e);e=b.query;for(h in e)isNaN(e[h])||(e[h]=Number(e[h]));g=Object.assign({},g,e);return this.ValidateSchema(g,c.paramschema,b,a)}return!0};f.deep_value=function(b,a){a=a.split(".");for(var c in a)b=b[a[c]];return b};var M=require("os");f.GetIPFromService=function(b){var a=M.networkInterfaces(),c=null;b.networkname&&(c=b.networkname);b=null;for(var e in a){for(var d in a[e]){var f=a[e][d];"IPv4"!==f.family||f.internal||(b=f.address)}if(e==
c)break}return b};f.getFunctionsOfObject=function(b){return Object.getOwnPropertyNames(b).filter(function(a){return"function"==typeof b[a]})};f.MakeDir=function(b){var a=require("child_process").exec;a("mkdir  "+b)};f.WriteFile=function(b,a){try{return D.writeFileSync(b,a,"utf8"),!0}catch(c){return!1}};f.FormatYYYYMMDD=function(b){return b.getUTCFullYear()+"-"+("0"+(b.getUTCMonth()+1)).slice(-2)+"-"+("0"+b.getUTCDate()).slice(-2)};f.FormatYYYYMMDDHHMMSS=function(b){return this.FormatYYYYMMDD(b)+"-"+
("0"+b.getUTCHours()).slice(-2)+"-"+("0"+b.getUTCMinutes()).slice(-2)+"-"+("0"+b.getUTCSeconds()).slice(-2)};f.FormatYYYYMMDDHHMMSSColon=function(b){return this.FormatYYYYMMDD(b)+"T"+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)};f.Median=function(b){b.sort(function(a,c){return a-c});var a=b.length,c=Math.floor(a/2),e;1===a%2?e=b[c]:e=(b[c-1]+b[c])/2;return e};f.LowPassFilter=function(b,a,c){if(.1<Math.abs(a)){var e=(a-b)/b;e>c?a=b*(1+
c):e<c&&(a=b*(1-c))}return a};f.PostPutHttp=function(b,a,c,e,d,f,g,k,h,m){var n={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":k.length};c&&(n[c.keyName]=c.keyValue);if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)r(a,n),a=null;a=null}b={hostname:d,port:g,path:f,method:b,headers:n,json:!0};a&&(b.auth=a);a=H;if("https"==e||"https:"==e)b.rejectUnauthorized=!1,a=J;e=a.request(b,function(a){var c="";a.setEncoding("utf8");
a.on("data",function(a){c+=a});a.on("end",function(){200!=a.statusCode&&(console.log("Error statusCode="+a.statusCode),c&&console.log("data="+JSON.stringify(c)));h&&h(m,a.statusCode,c)})});e.on("error",function(a){console.log("problem with request: "+a.message);h&&h(m,500,a)});e.write(k);e.end()};f.PostHttpAuth=function(b,a,c,e,d,f,g,k,h){this.PostPutHttp("POST",b,a,c,e,d,f,g,k,h)};f.PostHttp=function(b,a,c,e,d,f,g,k){this.PostPutHttp("POST",null,b,a,c,e,d,f,g,k)};f.PutHttp=function(b,a,c,e,d,f,g,
k){this.PostPutHttp("PUT",null,b,a,c,e,d,f,g,k)};f.GetHttpAuth=function(b,a,c,e,d){b=H.request({hostname:b,port:c,path:a+"/"+e,method:"GET",headers:{"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":e.length},json:!0},function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);d(a.statusCode,c)})});b.on("error",function(a){console.log("problem with request: "+
a.message)});b.end()};f.GetDeleteHttp=function(b,a,c,e,d,f,g,k,h,m){var n={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};c&&(n[c.keyName]=c.keyValue);if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)r(a,n),a=null;a=null}k&&(k=I.escape(k),f=f+"/?"+k);b={hostname:d,port:g,path:f,method:b,headers:n,json:!0};a&&(b.auth=a);a=H;if("https"==e||"https:"==e)b.rejectUnauthorized=!1,a=J;e=a.request(b,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=
a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);h(m,a.statusCode,c)})});e.on("error",function(a){console.log("problem with request: "+a.message)});e.end()};f.GetHttpProper=function(b,a,c,e,d,f,g,k,h){this.GetDeleteHttp("GET",b,a,c,e,d,f,g,k,h)};f.DeleteHttp=function(b,a,c,e,d,f,g,k,h){this.GetDeleteHttp("DELETE",b,a,c,e,d,f,g,k,h)};var F=0,L=require("url");try{var A=E.resolve(g("purpleskyutil.js"),"./lib/deploy.json"),G=D.readFileSync(A,"UTF8"),q=JSON.parse(G)}catch(b){"ENOENT"!=
b.code&&console.log(b.code+" - "+b.message)}f.RestTaskCall=function(b,a,c){var e=!1,d={};b.payload&&console.log("\t\tpayload ="+JSON.stringify(b.payload));var f=null;if(b.service&&b.servicepath){if(b.sysservice){if(!b.serviceconfig){d="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(d);a(c,404,JSON.stringify(d));return}var g=this.GetServiceConfig(b.serviceconfig,b.service)}else{if(!b.appserviceconfig){d="Parameter error: Task="+b.name+" does not contain appserviceconfig";
console.error(d);a(c,404,JSON.stringify(d));return}g=this.GetServiceConfig(b.appserviceconfig,b.service);if(!g){if(!b.serviceconfig){d="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(d);a(c,404,JSON.stringify(d));return}g=this.GetServiceConfig(b.serviceconfig,b.service)}}if(!(g&&"object"==typeof g&&g.hasOwnProperty("protocol")&&g.hasOwnProperty("hostname")&&g.hasOwnProperty("port"))){d="Parameter error: Task="+b.name+" has unrecognized service="+b.service+" sc="+JSON.stringify(g);
console.error(d);a(c,404,JSON.stringify(d));return}q&&q.dnsservicename&&"localhost"==g.hostname&&(g.hostname=b.service);e=!0;d.protocol=g.protocol;d.hostname=g.hostname;d.port=g.port;switch(g.security){case "basic":case "accesskey":f={};f.security=g.security;f.nonce=F++;f.acckey=b.acckey;f.secret=b.secretna;break;case "appkey":d.key=b.appkey?this.MakeKeyServiceAndKeyValue(b.service,b.appkey):this.MakeKeyServiceAndKeyValue(b.service,g.key)}d.pathname=b.servicepath;0!=d.pathname.search("/")&&(d.pathname=
"/"+d.pathname)}if(b.url||e)switch(e=null,b.payload&&(e=b.payload),b.url&&(d=L.parse(b.url),d.key=null),b.method){case "POST":b="";e&&(b=JSON.stringify(e));this.PostPutHttp("POST",f,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;case "PUT":b="";e&&(b=JSON.stringify(e));this.PostPutHttp("PUT",f,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;case "GET":b="";e&&(b=w(e));this.GetHttpProper(f,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;case "DELETE":b="";e&&(b=w(e));
this.DeleteHttp(f,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;default:d=b.hasOwnProperty("name")?"Parameter error: Task="+b.name+" has unrecognized method="+b.method:"Parameter error: unrecognized method="+b.method,console.error(d),a(c,404,{error:d})}else b.func?(b.payload&&JSON.parse(JSON.stringify(b.payload)),d=eval("this.to."+b.func+"(payload)"),a(c,200,d)):a(c,200,{})};f.ServiceKeyName=function(b){return b+"-api-key"};f.MakeKeyServiceAndKeyValue=function(b,a){if(!a)return null;
var c={};c.keyName=this.ServiceKeyName(b);c.keyValue=a;return c};f.EstablishKey=function(b,a){var c=D.readFileSync(b,"utf8");c=JSON.parse(c);var e=c.services;if(!e||!e[a]||"appkey"!==e[a].security)return null;e[a].key||(e[a].key=this.GenerateKeyFromDate((new Date).toString()),D.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return e[a].key};f.GenerateKeyFromDate=function(b){return z.createHash("md5").update(b).digest("hex")};f.GetServiceConfig=function(b,a){var c=D.readFileSync(b,"utf8");c=JSON.parse(c);
if(!c)return null;var e=c.services;if(!e||!e[a])return null;c=e[a];e[a].security||(e[a].security="nokey",D.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return e[a]};f.PriorityQueue=function(b){this._comparator=b||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=function(a,c){if("number"===typeof a&&"number"===typeof c)return a-c;a=a.toString();c=c.toString();return a==c?0:a>c?1:-1};f.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");
return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(a){a=this._elements.push(a);for(var c=a-1;0<c;){var b=c-1;if(0>=this._compare(c,b))break;this._swap(b,c);c=b}return a};this.size=function(){return this._elements.length};this.getElement=function(a){return 0>a||a>=this.size()?null:this._elements[a]};this.getElements=function(a){return this._elements};this.forEach=function(a){return this._elements.forEach(a)};this._compare=function(a,
c){return this._comparator(this._elements[a],this._elements[c])};this._swap=function(a,c){var b=this._elements[a];this._elements[a]=this._elements[c];this._elements[c]=b}};var v=require("cacheman");f.TtlCache=function(b,a,c){if(!b)return null;if(a||c){var e={};a&&(e.ttl=a);c&&(e.engine=c);this.cache=new v(b,e)}else this.cache=new v(b);this.Set=function(a,c,b){this.cache.set(a,c,b)};this.Get=function(a,c){this.cache.get(a,c)}};var K=require("dgram");f.Udp=function(b,a,c,e){this.server=K.createSocket("udp4");
b||a?(this.server.bind({address:c,port:e}),this.server.on("listen",b),this.server.on("message",a),this.broadcastMode=!1):this.broadcastMode=!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};this.broadcast=function(a,c,b){if(this.broadcastMode){var d=new Buffer(JSON.stringify(b));this.server.send(d,0,d.length,c,a,function(){console.log("Sent '"+d+"'")})}}};return m.exports};m[3]=function(m,f){function p(a){var c=JSON.stringify(b);
c=C.Cipher(q,c);v.writeFileSync(a,c)}function r(a,c){return{status:a,error:c}}function w(a){for(var c in b){var e=b[c];if(e.acckey==a)return e}return null}function H(a){a=w(a);if(!a)return null;a=JSON.parse(JSON.stringify(a));delete a.secret;return a}function J(a){var c=a.authorization;if(!c)return r("403","Authorization header missing");if(0!=c.search(/hmac /i)){if(c=a.authorization)if(0!=c.search(/basic /i))c=r(403,"basic authorization header needs to start with hmac");else{c=c.slice(6);c=Buffer.from(c,
"base64").toString().split(":");var b=c[0];c=(a=w(b))?c[1]===a.secret?a:r(403,"could not authenticate"):r(403,"acckey="+b+" not found")}else c=r("403","Authorization header missing");return c}b=c.slice(5).split(":");var d=b[0];c=w(d);if(!c)return r(403,"acckey="+d+" not found");a=a.date;d=b.splice(-1,1)[0];b=b.join(":");return z(c.secret,b+(":"+a))==d?c:r(403,"could not authenticate")}function D(a){var c=C.GetServiceConfig(L,a);return c?c:c=C.GetServiceConfig(A,a)}function E(a,c){var b=w(a);if(!b)return r(403,
"acckey invalid");var d=D(c);if(!d)return r(404,"No such service="+c);if("accesskey"!==d.security&&"basic"!==d.security)return r(403,"access is forbidden to service="+c);c&&0>b.services.indexOf(c)&&b.services.push(c);p(F);return H(a)}function I(a,c){var b=w(a);if(!b)return r(403,"acckey invalid");var d=D(c);if("accesskey"!==d.security&&"basic"!==d.security)return r(403,"access is forbidden");d=b.services.indexOf(c);if(0>d)return r(403,"no access to service="+c);b.services.splice(d,1);p(F);return H(a)}
function z(a,c){a=M.createHmac("sha256",a);a.update(c);return a.digest("hex")}var C=k(2,3),M=require("crypto"),F="./deploy/lib/aclconfig.json",L=g("apikeymgr.js")+"/deploy/lib/serviceconfig.json",A=L,G=g("apikeymgr.js"),q="secretkey",v=require("fs"),K=require("path"),b={};f.initialize=function(a){var c=F;a&&(G=a.appdir,c=a.aclconfig,A=K.resolve(G,a.appserviceconfig),q=a.secret);F=c=K.resolve(G,c);b=null;v.existsSync(c)&&(a=v.readFileSync(c,"utf8"),(a=C.Decipher(q,a))?(a=a.toString("UTF8"),b=JSON.parse(a)):
b=null);b||(b={},p(c))};f.Sign=function(a,c){return z(a,c)};f.RouteAllocateAccessKeys=function(a,c){a=a.params.clientid;var e=(new Date).valueOf(),d=Math.round(Math.random()*e),f=C.GenerateKeyFromDate(d.toString());d=Math.round(Math.random()*e);e=C.GenerateKeyFromDate(d.toString());d=[];b[a]||(b[a]={});b[a].acckey=f;b[a].secret=e;b[a].services=[];for(g in d)servicename&&0>b[a].services.indexOf(d[g])&&b[a].services.push(d[g]);p(F);var g=w(f);c.status(200).json(g)};f.RouteGetClientFromClientid=function(a,
c){a=a.params.clientid;a=b[a]?JSON.parse(JSON.stringify(b[a])):null;null==a?c.status(401).json({error:"client does not have accesskeys"}):c.status(200).json(a)};f.RouteGetClientFromAcckey=function(a,c){a=w(a.params.acckey);null==a?c.status(401).json({error:"client does not have accesskeys"}):c.status(200).json(a)};f.RouteRevokeClient=function(a,c){a=a.params.clientid;b[a]?(delete b[a],a=!0):a=!1;a?c.status(200).json({data:"OK"}):c.status(401).json({error:"client does not have accesskeys"})};f.RouteGrantAccess=
function(a,c){a=E(a.params.acckey,a.params.servicename);a.error?c.status(a.status).json({error:a.error}):c.status(200).json(a)};f.RouteRevokeAccess=function(a,c){a=I(a.params.acckey,a.params.servicename);a.error?c.status(a.status).json({error:a.error}):c.status(200).json(a)};f.RouteGetAccessServices=function(a,c){a=H(a.params.acckey);if(!a)return r(403,"acckey invalid");c.status(200).json(a.services)};f.RouteGetAccessOneService=function(a,c){var b=a.params.servicename;b=(a=H(a.params.acckey))?0>a.services.indexOf(b)?
r(404,"access was never granted to client="+a.clientid+" for service="+b):b:r(403,"acckey invalid");b.error?c.status(b.status).json({error:b.error}):c.status(200).json(b)};f.CheckServiceAccess=function(a,c,b){a=J(a.headers);return a.error?a:0>a.services.indexOf(b)?r(404,"access was never granted to client="+a.clientid+" for service="+b):b};f.RouteCheckAccessOneService=function(a,b){var c=J(a.body.headers);c.error?b.status(403).send({error:"not autherized"}):0>c.services.indexOf(a.body.servicename)?
b.status(404).json({error:"access was never granted to client="+c.clientid+" for service="+servicename}):b.status(200).json({servicename:a.body.servicename})};return m.exports};if("object"===typeof module)module.exports=k(0);else return k(0)})();
