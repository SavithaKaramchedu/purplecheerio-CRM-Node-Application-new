var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.owns=function(g,p){return Object.prototype.hasOwnProperty.call(g,p)};$jscomp.assign="function"==typeof Object.assign?Object.assign:function(g,p){for(var k=1;k<arguments.length;k++){var h=arguments[k];if(h)for(var n in h)$jscomp.owns(h,n)&&(g[n]=h[n])}return g};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(g,p,k){g!=Array.prototype&&g!=Object.prototype&&(g[p]=k.value)};$jscomp.getGlobal=function(g){return"undefined"!=typeof window&&window===g?g:"undefined"!=typeof global&&null!=global?global:g};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(g,p,k,h){if(p){k=$jscomp.global;g=g.split(".");for(h=0;h<g.length-1;h++){var n=g[h];n in k||(k[n]={});k=k[n]}g=g[g.length-1];h=k[g];p=p(h);p!=h&&null!=p&&$jscomp.defineProperty(k,g,{configurable:!0,writable:!0,value:p})}};$jscomp.polyfill("Object.assign",function(g){return g||$jscomp.assign},"es6","es3");
(function(){function g(g,f){n[g]||(h[g]={exports:{},loaded:!1},n[g]=!0,0===g&&"function"===typeof require?require.main=h[0]:h[g].parent=h[f],k[g].call(this,h[g],h[g].exports),h[g].loaded=!0);return h[g].exports}function p(g){return require("path").resolve(__dirname+"/"+g+"/../")}var k={},h={},n={};k[0]=function(h,f){function k(b,a){b=q.createHmac("sha256",b);b.update(a);return b.digest("hex")}function m(b,a){var c=g(1,0);if(b.secret&&b.acckey){if("accesskey"===b.security){var d=new Date,e=b.acckey+
":"+b.nonce;a.Authorization="hmac "+e+":"+c.Sign(b.secret,e+":"+d);a.Date=d;return}if("basic"===b.security){c=Buffer.from(b.acckey+":"+b.secret).toString("base64");a.Authorization="basic "+c;return}}b.Authorization?(a.Authorization=b.Authorization,c=a.Authorization.indexOf("hmac "),0!=c?(c=a.Authorization.search(/basic /i),0!==c&&console.log("badly formed authorization string - needs to start with hmac")):(c=a.Authorization.slice(c+5),c.split(":"),a.Date=b.Date)):console.log("missing authorization string")}
function n(b){if(!b)return null;var a="",c;for(c in b)"object"===typeof b[c]?(""!=a&&(a+="&"),a+=c+"="+JSON.stringify(b[c])):"array"!==typeof b[c]&&(""!=a&&(a+="&"),a+=c+"="+b[c]);return a}var t=require("http"),y=require("https"),r=require("fs"),D=require("path"),E=require("querystring"),q=require("crypto"),u=require("jsonschema").Validator;f.Cipher=function(b,a){var c=q.randomBytes(16).toString("hex").slice(0,16),d=q.createHash("sha256").update(b).digest("hex");d=d.slice(0,32);a=q.createCipheriv("aes-256-ctr",
d,c).update(a).toString("hex");b=k(b,a);return c+":::"+a+":::"+b};f.Decipher=function(b,a){var c=a.split(":::");a=c[0];var d=c[2],e=k(b,c[1]);if(d!=e)return null;c=new Buffer(c[1],"hex");b=q.createHash("sha256").update(b).digest("hex");b=b.slice(0,32);return q.createDecipheriv("aes-256-ctr",b,a).update(c)};f.ValidateSchemaErrorObject=function(b,a){b=(new u).validate(b,a);if(b.errors.length){a="";for(var c in b.errors)a+=b.errors[c].stack+" ";return a}return null};f.ValidateSchema=function(b,a,c,d){return(b=
this.ValidateSchemaErrorObject(b,a))?(d.status(422).json({errors:b}),!1):!0};f.BodyValidate=function(b,a,c,d){return c&&c.bodyschema?(d&&(c.bodyschema.definitions=c.bodyschema.definitions?Object.assign(c.bodyschema.definitions,d):d),this.ValidateSchema(b.body,c.bodyschema,b,a)):!0};f.ParamValidate=function(b,a,c,d){if(c&&c.paramschema){var e=b.params[0],l=c.route;"/"==l.slice(0,1)&&(l=l.slice(1));"/"==e.slice(0,1)&&(e=e.slice(1));"/"==l.slice(-1)&&(l=l.slice(0,-1));"/"==e.slice(-1)&&(e=e.slice(0,
-1));for(var f={};""!=l;){var g=!1;":"==l.slice(0,1)&&(g=!0,l=l.slice(1));var h=l.search("/"),k=e.search("/");if(0<=h){var m=l.slice(0,h);l=l.slice(h+1);var G=e.slice(0,k);e=e.slice(k+1)}else m=l.slice(0),l="",G=e.slice(0),e="";g&&(g=Number(G),isNaN(g)?f[m]=G:f[m]=g)}d&&(c.paramschema.definitions=c.paramschema.definitions?Object.assign(c.paramschema.definitions,d):d);d=b.query;for(h in d)isNaN(d[h])||(d[h]=Number(d[h]));f=Object.assign({},f,d);return this.ValidateSchema(f,c.paramschema,b,a)}return!0};
f.deep_value=function(b,a){a=a.split(".");for(var c in a)b=b[a[c]];return b};var H=require("os");f.GetIPFromService=function(b){var a=H.networkInterfaces(),c=null;b.networkname&&(c=b.networkname);b=null;for(var d in a){for(var e in a[d]){var l=a[d][e];"IPv4"!==l.family||l.internal||(b=l.address)}if(d==c)break}return b};f.getFunctionsOfObject=function(b){return Object.getOwnPropertyNames(b).filter(function(a){return"function"==typeof b[a]})};f.MakeDir=function(b){var a=require("child_process").exec;
a("mkdir  "+b)};f.WriteFile=function(b,a){try{return r.writeFileSync(b,a,"utf8"),!0}catch(c){return!1}};f.FormatYYYYMMDD=function(b){return b.getUTCFullYear()+"-"+("0"+(b.getUTCMonth()+1)).slice(-2)+"-"+("0"+b.getUTCDate()).slice(-2)};f.FormatYYYYMMDDHHMMSS=function(b){return this.FormatYYYYMMDD(b)+"-"+("0"+b.getUTCHours()).slice(-2)+"-"+("0"+b.getUTCMinutes()).slice(-2)+"-"+("0"+b.getUTCSeconds()).slice(-2)};f.FormatYYYYMMDDHHMMSSColon=function(b){return this.FormatYYYYMMDD(b)+"T"+("0"+b.getUTCHours()).slice(-2)+
":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)};f.Median=function(b){b.sort(function(a,b){return a-b});var a=b.length,c=Math.floor(a/2),d;1===a%2?d=b[c]:d=(b[c-1]+b[c])/2;return d};f.LowPassFilter=function(b,a,c){if(.1<Math.abs(a)){var d=(a-b)/b;d>c?a=b*(1+c):d<c&&(a=b*(1-c))}return a};f.PostPutHttp=function(b,a,c,d,e,l,f,g,h,k){var F={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":g.length};c&&(F[c.keyName]=c.keyValue);
if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)m(a,F),a=null;a=null}b={hostname:e,port:f,path:l,method:b,headers:F,json:!0};a&&(b.auth=a);a=t;if("https"==d||"https:"==d)b.rejectUnauthorized=!1,a=y;d=a.request(b,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&(console.log("Error statusCode="+a.statusCode),b&&console.log("data="+JSON.stringify(b)));h&&h(k,a.statusCode,b)})});d.on("error",function(a){console.log("problem with request: "+
a.message);h&&h(k,500,a)});d.write(g);d.end()};f.PostHttpAuth=function(b,a,c,d,e,l,f,g,h){this.PostPutHttp("POST",b,a,c,d,e,l,f,g,h)};f.PostHttp=function(b,a,c,d,e,l,f,g){this.PostPutHttp("POST",null,b,a,c,d,e,l,f,g)};f.PutHttp=function(b,a,c,d,e,l,f,g){this.PostPutHttp("PUT",null,b,a,c,d,e,l,f,g)};f.GetHttpAuth=function(b,a,c,d,e){b=t.request({hostname:b,port:c,path:a+"/"+d,method:"GET",headers:{"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":d.length},
json:!0},function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);e(a.statusCode,b)})});b.on("error",function(a){console.log("problem with request: "+a.message)});b.end()};f.GetDeleteHttp=function(b,a,c,d,e,f,g,h,k,p){var l={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};c&&(l[c.keyName]=c.keyValue);if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)m(a,l),a=null;
a=null}h&&(h=E.escape(h),f=f+"/?"+h);b={hostname:e,port:g,path:f,method:b,headers:l,json:!0};a&&(b.auth=a);a=t;if("https"==d||"https:"==d)b.rejectUnauthorized=!1,a=y;d=a.request(b,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);k(p,a.statusCode,b)})});d.on("error",function(a){console.log("problem with request: "+a.message)});d.end()};f.GetHttpProper=function(b,a,c,d,e,f,g,h,k){this.GetDeleteHttp("GET",
b,a,c,d,e,f,g,h,k)};f.DeleteHttp=function(b,a,c,d,e,f,g,h,k){this.GetDeleteHttp("DELETE",b,a,c,d,e,f,g,h,k)};var v=0,A=require("url");try{var B=D.resolve(p("purpleskyutil.js"),"./lib/deploy.json"),z=r.readFileSync(B,"UTF8"),w=JSON.parse(z)}catch(b){"ENOENT"!=b.code&&console.log(b.code+" - "+b.message)}f.RestTaskCall=function(b,a,c){var d=!1,e={};b.payload&&console.log("\t\tpayload ="+JSON.stringify(b.payload));var f=null;if(b.service&&b.servicepath){if(b.sysservice){if(!b.serviceconfig){e="Parameter error: Task="+
b.name+" does not contain serviceconfig";console.error(e);a(c,404,JSON.stringify(e));return}var g=this.GetServiceConfig(b.serviceconfig,b.service)}else{if(!b.appserviceconfig){e="Parameter error: Task="+b.name+" does not contain appserviceconfig";console.error(e);a(c,404,JSON.stringify(e));return}g=this.GetServiceConfig(b.appserviceconfig,b.service);if(!g){if(!b.serviceconfig){e="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(e);a(c,404,JSON.stringify(e));return}g=
this.GetServiceConfig(b.serviceconfig,b.service)}}if(!(g&&"object"==typeof g&&g.hasOwnProperty("protocol")&&g.hasOwnProperty("hostname")&&g.hasOwnProperty("port"))){e="Parameter error: Task="+b.name+" has unrecognized service="+b.service+" sc="+JSON.stringify(g);console.error(e);a(c,404,JSON.stringify(e));return}w&&w.dnsservicename&&"localhost"==g.hostname&&(g.hostname=b.service);d=!0;e.protocol=g.protocol;e.hostname=g.hostname;e.port=g.port;switch(g.security){case "basic":case "accesskey":f={};f.security=
g.security;f.nonce=v++;f.acckey=b.acckey;f.secret=b.secretna;break;case "appkey":e.key=b.appkey?this.MakeKeyServiceAndKeyValue(b.service,b.appkey):this.MakeKeyServiceAndKeyValue(b.service,g.key)}e.pathname=b.servicepath;0!=e.pathname.search("/")&&(e.pathname="/"+e.pathname)}if(b.url||d)switch(d=null,b.payload&&(d=b.payload),b.url&&(e=A.parse(b.url),e.key=null),b.method){case "POST":b="";d&&(b=JSON.stringify(d));this.PostPutHttp("POST",f,e.key,e.protocol,e.hostname,e.pathname,e.port,b,a,c);break;case "PUT":b=
"";d&&(b=JSON.stringify(d));this.PostPutHttp("PUT",f,e.key,e.protocol,e.hostname,e.pathname,e.port,b,a,c);break;case "GET":b="";d&&(b=n(d));this.GetHttpProper(f,e.key,e.protocol,e.hostname,e.pathname,e.port,b,a,c);break;case "DELETE":b="";d&&(b=n(d));this.DeleteHttp(f,e.key,e.protocol,e.hostname,e.pathname,e.port,b,a,c);break;default:e=b.hasOwnProperty("name")?"Parameter error: Task="+b.name+" has unrecognized method="+b.method:"Parameter error: unrecognized method="+b.method,console.error(e),a(c,
404,{error:e})}else b.func?(b.payload&&JSON.parse(JSON.stringify(b.payload)),e=eval("this.to."+b.func+"(payload)"),a(c,200,e)):a(c,200,{})};f.ServiceKeyName=function(b){return b+"-api-key"};f.MakeKeyServiceAndKeyValue=function(b,a){if(!a)return null;var c={};c.keyName=this.ServiceKeyName(b);c.keyValue=a;return c};f.EstablishKey=function(b,a){var c=r.readFileSync(b,"utf8");c=JSON.parse(c);var d=c.services;if(!d||!d[a]||"appkey"!==d[a].security)return null;d[a].key||(d[a].key=this.GenerateKeyFromDate((new Date).toString()),
r.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return d[a].key};f.GenerateKeyFromDate=function(b){return q.createHash("md5").update(b).digest("hex")};f.GetServiceConfig=function(b,a){var c=r.readFileSync(b,"utf8");c=JSON.parse(c);if(!c)return null;var d=c.services;if(!d||!d[a])return null;c=d[a];d[a].security||(d[a].security="nokey",r.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return d[a]};f.PriorityQueue=function(b){this._comparator=b||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=
function(a,b){if("number"===typeof a&&"number"===typeof b)return a-b;a=a.toString();b=b.toString();return a==b?0:a>b?1:-1};f.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(a){a=this._elements.push(a);for(var b=a-1;0<b;){var d=b-1;if(0>=this._compare(b,d))break;this._swap(d,b);b=d}return a};this.size=
function(){return this._elements.length};this.getElement=function(a){return 0>a||a>=this.size()?null:this._elements[a]};this.getElements=function(a){return this._elements};this.forEach=function(a){return this._elements.forEach(a)};this._compare=function(a,b){return this._comparator(this._elements[a],this._elements[b])};this._swap=function(a,b){var c=this._elements[a];this._elements[a]=this._elements[b];this._elements[b]=c}};var x=require("cacheman");f.TtlCache=function(b,a,c){if(!b)return null;if(a||
c){var d={};a&&(d.ttl=a);c&&(d.engine=c);this.cache=new x(b,d)}else this.cache=new x(b);this.Set=function(a,b,c){this.cache.set(a,b,c)};this.Get=function(a,b){this.cache.get(a,b)}};var C=require("dgram");f.Udp=function(b,a,c,d){this.server=C.createSocket("udp4");b||a?(this.server.bind({address:c,port:d}),this.server.on("listen",b),this.server.on("message",a),this.broadcastMode=!1):this.broadcastMode=!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};
this.broadcast=function(a,b,c){if(this.broadcastMode){var d=new Buffer(JSON.stringify(c));this.server.send(d,0,d.length,b,a,function(){console.log("Sent '"+d+"'")})}}};return h.exports};k[1]=function(h,f){function k(a){var c=JSON.stringify(b);c=u.Cipher(w,c);x.writeFileSync(a,c)}function m(a,b){return{status:a,error:b}}function n(a){for(var c in b){var d=b[c];if(d.acckey==a)return d}return null}function t(a){a=n(a);if(!a)return null;a=JSON.parse(JSON.stringify(a));delete a.secret;return a}function y(a){var b=
a.authorization;if(!b)return m("403","Authorization header missing");if(0!=b.search(/hmac /i)){if(b=a.authorization)if(0!=b.search(/basic /i))b=m(403,"basic authorization header needs to start with hmac");else{b=b.slice(6);b=Buffer.from(b,"base64").toString().split(":");var d=b[0];b=(a=n(d))?b[1]===a.secret?a:m(403,"could not authenticate"):m(403,"acckey="+d+" not found")}else b=m("403","Authorization header missing");return b}d=b.slice(5).split(":");var e=d[0];b=n(e);if(!b)return m(403,"acckey="+
e+" not found");a=a.date;e=d.splice(-1,1)[0];d=d.join(":");return q(b.secret,d+(":"+a))==e?b:m(403,"could not authenticate")}function r(a){var b=u.GetServiceConfig(A,a);return b?b:b=u.GetServiceConfig(B,a)}function D(a,b){var c=n(a);if(!c)return m(403,"acckey invalid");var e=r(b);if(!e)return m(404,"No such service="+b);if("accesskey"!==e.security&&"basic"!==e.security)return m(403,"access is forbidden to service="+b);b&&0>c.services.indexOf(b)&&c.services.push(b);k(v);return t(a)}function E(a,b){var c=
n(a);if(!c)return m(403,"acckey invalid");var e=r(b);if("accesskey"!==e.security&&"basic"!==e.security)return m(403,"access is forbidden");e=c.services.indexOf(b);if(0>e)return m(403,"no access to service="+b);c.services.splice(e,1);k(v);return t(a)}function q(a,b){a=H.createHmac("sha256",a);a.update(b);return a.digest("hex")}var u=g(0,1),H=require("crypto"),v="./deploy/lib/aclconfig.json",A=p("apikeymgr.js")+"/deploy/lib/serviceconfig.json",B=A,z=p("apikeymgr.js"),w="secretkey",x=require("fs"),C=
require("path"),b={};f.initialize=function(a){var c=v;a&&(z=a.appdir,c=a.aclconfig,B=C.resolve(z,a.appserviceconfig),w=a.secret);v=c=C.resolve(z,c);b=null;x.existsSync(c)&&(a=x.readFileSync(c,"utf8"),(a=u.Decipher(w,a))?(a=a.toString("UTF8"),b=JSON.parse(a)):b=null);b||(b={},k(c))};f.Sign=function(a,b){return q(a,b)};f.RouteAllocateAccessKeys=function(a,c){a=a.params.clientid;var d=(new Date).valueOf(),e=Math.round(Math.random()*d),g=u.GenerateKeyFromDate(e.toString());e=Math.round(Math.random()*
d);d=u.GenerateKeyFromDate(e.toString());e=[];b[a]||(b[a]={});b[a].acckey=g;b[a].secret=d;b[a].services=[];for(f in e)servicename&&0>b[a].services.indexOf(e[f])&&b[a].services.push(e[f]);k(v);var f=n(g);c.status(200).json(f)};f.RouteGetClientFromClientid=function(a,c){a=a.params.clientid;a=b[a]?JSON.parse(JSON.stringify(b[a])):null;null==a?c.status(401).json({error:"client does not have accesskeys"}):c.status(200).json(a)};f.RouteGetClientFromAcckey=function(a,b){a=n(a.params.acckey);null==a?b.status(401).json({error:"client does not have accesskeys"}):
b.status(200).json(a)};f.RouteRevokeClient=function(a,c){a=a.params.clientid;b[a]?(delete b[a],a=!0):a=!1;a?c.status(200).json({data:"OK"}):c.status(401).json({error:"client does not have accesskeys"})};f.RouteGrantAccess=function(a,b){a=D(a.params.acckey,a.params.servicename);a.error?b.status(a.status).json({error:a.error}):b.status(200).json(a)};f.RouteRevokeAccess=function(a,b){a=E(a.params.acckey,a.params.servicename);a.error?b.status(a.status).json({error:a.error}):b.status(200).json(a)};f.RouteGetAccessServices=
function(a,b){a=t(a.params.acckey);if(!a)return m(403,"acckey invalid");b.status(200).json(a.services)};f.RouteGetAccessOneService=function(a,b){var c=a.params.servicename;c=(a=t(a.params.acckey))?0>a.services.indexOf(c)?m(404,"access was never granted to client="+a.clientid+" for service="+c):c:m(403,"acckey invalid");c.error?b.status(c.status).json({error:c.error}):b.status(200).json(c)};f.CheckServiceAccess=function(a,b,d){a=y(a.headers);return a.error?a:0>a.services.indexOf(d)?m(404,"access was never granted to client="+
a.clientid+" for service="+d):d};f.RouteCheckAccessOneService=function(a,b){var c=y(a.body.headers);c.error?b.status(403).send({error:"not autherized"}):0>c.services.indexOf(a.body.servicename)?b.status(404).json({error:"access was never granted to client="+c.clientid+" for service="+servicename}):b.status(200).json({servicename:a.body.servicename})};return h.exports};if("object"===typeof module)module.exports=g(0);else return g(0)})();
