var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(m){var g=function(){};g.prototype=m;return new g};$jscomp.underscoreProtoCanBeSet=function(){var m={a:!0},g={};try{return g.__proto__=m,g.a}catch(n){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(m,g){m.__proto__=g;if(m.__proto__!==g)throw new TypeError(m+" is not extensible");return m}:null;
$jscomp.inherits=function(m,g){m.prototype=$jscomp.objectCreate(g.prototype);m.prototype.constructor=m;if($jscomp.setPrototypeOf){var n=$jscomp.setPrototypeOf;n(m,g)}else for(n in g)if("prototype"!=n)if(Object.defineProperties){var q=Object.getOwnPropertyDescriptor(g,n);q&&Object.defineProperty(m,n,q)}else m[n]=g[n];m.superClass_=g.prototype};$jscomp.owns=function(m,g){return Object.prototype.hasOwnProperty.call(m,g)};
$jscomp.assign="function"==typeof Object.assign?Object.assign:function(m,g){for(var n=1;n<arguments.length;n++){var q=arguments[n];if(q)for(var w in q)$jscomp.owns(q,w)&&(m[w]=q[w])}return m};$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(m,g,n){m!=Array.prototype&&m!=Object.prototype&&(m[g]=n.value)};$jscomp.getGlobal=function(m){return"undefined"!=typeof window&&window===m?m:"undefined"!=typeof global&&null!=global?global:m};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(m,g,n,q){if(g){n=$jscomp.global;m=m.split(".");for(q=0;q<m.length-1;q++){var w=m[q];w in n||(n[w]={});n=n[w]}m=m[m.length-1];q=n[m];g=g(q);g!=q&&null!=g&&$jscomp.defineProperty(n,m,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Object.assign",function(m){return m||$jscomp.assign},"es6","es3");
(function(){function m(g,f){w[g]||(q[g]={exports:{},loaded:!1},w[g]=!0,0===g&&"function"===typeof require?require.main=q[0]:q[g].parent=q[f],n[g].call(this,q[g],q[g].exports),q[g].loaded=!0);return q[g].exports}function g(g){return require("path").resolve(__dirname+"/"+g+"/../")}var n={},q={},w={};n[0]=function(n,f){function q(a,b,c){c=c.toLowerCase();var e=[];try{e=a.routes.filter(function(a,d){d=a.route;if("static"===a.type)x=d;else{var x=d.replace(/\/:[a-z0-9A-Z.%\-,;:()*?@'!]+/g,"/[a-z0-9A-Z.%\\-,;:()*?@'!]+");
"/"==b[b.length-1]&&"/"!=d[d.length-1]&&(x+="\\/");"/"!=b[b.length-1]&&"/"==d[d.length-1]&&(b+="/");x+="$"}if(0==b.search(new RegExp(x,"g"))&&(a.type.toLowerCase()==c||"static"==a.type.toLowerCase()&&"get"===c))throw e.push(a),e;})}catch(r){if("array"==typeof r)return r}return e[0]}function y(a,b,c){return a.routes.filter(function(a){return a.route==b&&a.type==c})[0]}function O(d,h,l){h&&(p=h);this.use(G.json());this.use(G.urlencoded({extended:!0}));this.use(B.static(a.join(g("index.js"),"templates")));
this.use("/service",B.static(a.join(g("index.js"),"templates")));this.use("/samples",B.static(a.join(g("index.js"),"templates")));this.use("/dashboard",B.static(a.join(g("index.js"),"templates")));this.use("/css",B.static(a.join(g("index.js"),"templates")));this.use("/images",B.static(a.join(g("index.js"),"templates")));this.use("/css/bootstrap.css.map/",B.static(a.join(g("index.js"),"templates")));this.use("/documentation",function(a,c){a=b.readFileSync(g("index.js")+"/templates/documentation.html",
"utf8");c.set("Content-Type","text/html");a=E(a);c.send(a)});this.use("/test",function(a,b){I(a,b,!0,null,null)});this.use("/testhttp",function(a,b){I(a,b,!1,null,null)});this.get("/routelist/:servicename",function(c,d){if(c.params.servicename){var k=p.services[c.params.servicename];if(k)if(k&&k.configfilepath){var x=g("index.js");e&&(x=e);k=a.resolve(x,k.configfilepath);b.existsSync(k)?(c=require(k),d.json(c.routes)):d.status(404).send("service="+c.params.servicename+" not deployed")}else c="servicename="+
c.params.servicename+" not found",console.log(c),d.status(404).send(c);else console.log("servicename="+c.params.servicename+" not found in serviceconfig.json")}else d.status(422).send("servicename is required")});this.use("/servicelist",function(c,e){c=b.readFileSync(g("index.js")+"/templates/services.html","utf8");var d="",k="",x=!1;p.services.hasOwnProperty("keymgr")&&(x=!0);var l="";x||(l="There are system services available. To see the list of services, please run the keymgr service. For an example of how to run keymgr system service, please see corresponding usage in runsampleservice.bash in examples directory.");
for(var u in p.services){var h="",t=p.services[u];if(x){var r=a.resolve(g("index.js"),t.configfilepath);if(!b.existsSync(r)){console.log("service="+u+" not deployed configpath="+r+" does not exist");continue}}d+="<li><a class='scrollto' href='#"+u+"'>"+u+"</a></li>";h+="<p><b>"+t.description+"</b></p><br/>";h+="<p><b>Documentation: </b><a class='btn-purple' href=/service/"+u+">"+u+"</a></p>";if(t.pathsamples){var f=null;r=a.resolve(g("index.js"),t.pathsamples+"/examples.json");try{f=require(r)}catch(S){console.log("samples for "+
r+" do not exist diname="+g("index.js"))}f&&(h+="<p><b>Examples:</b><a class='btn-purple' href=/samples/"+u+">"+u+"</a></p>")}h+="<br/>";x&&(h+="For an example of how to run "+u+" system service, please see corresponding usage in runsampleservice.bash in examples directory.",h+="<br/>",h+="<p><b>Launch command: </b>node ../purplesky/purplerouteservice.js -s "+u,t.init&&t.init.optionschema&&(h+=" -i &lt;option json&gt;</p>",h+="<p>&lt;option json&gt; needs to conform to this schema:</p>",h+="<pre>"+
JSON.stringify(t.init.optionschema,0,2)+"</pre>",t.init.options&&(h+="<p>default &lt;option json&gt;:</p>",h+="<pre>"+JSON.stringify(t.init.options,0,2)+"</pre>")));k+='<section id="REPLservicename" class="doc-section"><h2 class="section-title">REPLservicename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",h).replace(/REPLservicename/g,u)}c=c.replace("REPLNotice",l).replace("REPLservicelist",d).replace("REPLsectioncontent",k);c=E(c);e.send(c)});
this.get("/routeinfo/:servicename",function(b,c){if(b.params.servicename)if(b.query.r)if(b.query.m){var d=p.services[b.params.servicename];if(d){var k=g("index.js");e&&(k=e);d=require(a.resolve(k,d.configfilepath));(b=y(d,b.query.r,b.query.m))||(b=d.routes[0]);b.configured?c.json(b):c.status(422).send("route not configured")}else b="servicename="+b.params.servicename+" not found in serviceconfig.json",console.log(b),c.status(403).send(b)}else c.status(422).send("method is required");else c.status(422).send("routename is required");
else c.status(422).send("servicename is required")});this.use("/service/:servicename",function(d,k){a:if(d=d.params.servicename){var l=p.services[d];if(l)if(l.configfilepath){var u=b.readFileSync(g("index.js")+"/templates/routes.html","utf8");u=u.replace("REPLservicedescription",l.description);var h="",x="",t=g("index.js");e&&(t=e);try{var r=require(a.resolve(t,l.configfilepath))}catch(N){console.log(N);k.status(422).send(N);break a}for(var f in r.routes)if(l=r.routes[f],l.configured){t="";t+="<h6><pre>"+
l.description+"</pre></h6>";t+="<h6>method="+l.type+"</h6>";l.paramschema&&(t+="<br><pre>parameter="+JSON.stringify(l.paramschema,0,2)+"</pre>");l.bodyschema&&(t+="<br><pre>payload="+JSON.stringify(l.bodyschema,0,2)+"</pre>");l.responseschema&&(t+="<br><pre>returnValue="+JSON.stringify(l.responseschema,0,2)+"</pre>");if(l.examples&&Array.isArray(l.examples)&&0<l.examples.length){t+="<br><h6>examples:</h6><pre>";for(var z in l.examples)0<z&&(t+="<br>"),l.examples[z].param&&(t+="params="+c(l.examples[z].param)),
l.examples[z].payload&&(t+="payload="+JSON.stringify(l.examples[z].payload,0,2));t+="</pre>"}h+="<li><a class='scrollto' href='#"+l.route+"'>"+l.route+"</a></li>";x+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",t).replace(/REPLroutename/g,l.route)}u=u.replace(/REPLservice/g,d).replace("REPLroutelist",h).replace("REPLsectioncontent",x).replace(/REPLHeader/,
"Documentation for the service").replace(/REPLSectionHeader/g,"API Routes");u=E(u);k.send(u)}else r="servicename="+d+" has no configfilepath",console.log(r),k.status(422).send(r);else r="servicename="+d+" not found in serviceconfig.json",console.log(r),k.status(422).send(r)}else k.status(422).send("servicename is required")});this.use("/samples/:servicename",function(c,e){if(c=c.params.servicename){var d=p.services[c];if(!d)console.log("servicename="+c+" not found in serviceconfig.json");else if(d.pathsamples){var k=
null,l=a.resolve(g("index.js"),d.pathsamples+"/examples.json");try{k=require(l)}catch(T){console.log("samples for "+l+" do not exist")}l=b.readFileSync(g("index.js")+"/templates/routes.html","utf8");l=l.replace("REPLservicedescription",d.description);var u="",t="";if(k)for(var h in k.Samples){var x=k.Samples[h],r="";r+="<h6><pre>"+x.description+"</pre></h6>";for(var f in x.code){var z=b.readFileSync(a.resolve(g("index.js"),d.pathsamples+"/"+x.code[f]),"utf8"),m="code";x.code[f].search(".sh")==x.code[f].length-
3&&(m="bashcode");r=x.code[f].search(".html")==x.code[f].length-5?r+("<div>"+z+"</div>"):r+("<pre class='"+m+"'>"+z+"</pre>")}u+="<li><a class='scrollto' href='#"+h+"'>"+h+"</a></li>";t+='<section id="REPLroutename" class="doc-section"><h2 class="section-title">REPLroutename</h2><div class="section-block"><p>REPLsectioncontent</p></div></section>'.replace("REPLsectioncontent",r).replace(/REPLroutename/g,h)}l=l.replace(/REPLservice/g,c).replace("REPLroutelist",u).replace("REPLsectioncontent",t).replace(/REPLHeader/,
"Sample code for the service").replace(/REPLSectionHeader/g,"Examples");l=E(l);e.send(l)}}else e.status(422).send("servicename is required")});this.use("/testhttpapi",function(a,b){a:{var c={},e={req:a,res:b,fService:!1};if(a.body.method){a.body.method=a.body.method.toLowerCase();var d={security:"accesskey"};d.Authorization=a.body.auth;d.Date=a.body.date;switch(a.body.method){case "post":try{""!==a.body.payload&&(c=JSON.parse(a.body.payload))}catch(Q){b.json({error:"payload is not proper json"});
break a}v.PostPutHttp("POST",d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),A,e);break;case "put":try{c=JSON.parse(a.body.payload)}catch(Q){b.json({error:"payload is not proper json"});break a}v.PostPutHttp("PUT",null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),A,e);break;case "get":v.GetHttpProper(d,null,a.body.protocol,a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),A,e);break;case "delete":v.DeleteHttp(d,null,a.body.protocol,
a.body.hostname,a.body.routena,a.body.port,JSON.stringify(c),A,e)}}else b.send("error - method missing in the form")}});this.use("/testapi",function(a,b){"save"===a.body.action?b.json("Saved"):C(a,b,h,A,{req:a,res:b,fService:!0})});this.validatesecurekey(d,h);this.get("/logoutbasic",function(a,b){switch(p.services[d].security){case "basic":b.status(401).send("Logged out");break;default:b.status(404).send("logoutbasic command available only when security is basic")}});var k=p.services[d];this.BodyValidate(k.configfilepath);
if(k.init&&"object"==typeof k.init&&k.init.class&&k.init.function){var r=require(a.resolve(g("index.js"),k.init.class)),t=null;l&&(t=l);k.init.options&&!t&&(t=k.init.options);if(k.init.optionschema&&(l=v.ValidateSchemaErrorObject(t,k.init.optionschema))){console.error("options do not conform to schema error="+l);return}r[k.init.function](t)}}function w(b){var c=g("index.js");e&&(c=e);var d=require(a.resolve(c,b));this.post("/*",function(a,b,c){var e=q(d,a.path,a.method);e?v.ParamValidate(a,b,e,d.definitions)&&
v.BodyValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.put("/*",function(a,b,c){var e=q(d,a.path,a.method);e?v.ParamValidate(a,b,e,d.definitions)&&v.BodyValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.get("/*",function(a,b,c){var e=q(d,a.path,a.method);e?v.ParamValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.delete("/*",function(a,b,c){var e=q(d,a.path,
a.method);e?v.ParamValidate(a,b,e,d.definitions)&&c():b.status(422).json({errors:"path="+a.path+" not found"})});this.use(function(a,b,c){var e=b.send;b.send=function(c){var k=q(d,a.path,a.method),l=null;k&&k.responseschema&&(d.definitions&&(k.responseschema.definitions=k.responseschema.definitions?Object.assign(k.responseschema.definitions,definitions):d.definitions),l=v.ValidateSchemaErrorObject(JSON.parse(c),k.responseschema));l&&(arguments[0]=JSON.stringify({error:l}),b.status(422));e.apply(b,
arguments)};c()})}function J(a,b,c){try{JSON.parse(c)}catch(u){}200!=b?a.res.status(b).json(JSON.stringify(c)):a.next()}function D(a,b){this.use(function(b,c,e){switch(p.services[a].security){case "appkey":var d=v.ServiceKeyName(a);if(!b.headers[d]||b.headers[d]!==p.services[a].key){b="invalid key to service="+d+" value="+b.headers[d];c.status(401).send(b);return}break;case "basic":d=null;b.headers&&(d=b.headers.authorization);if(!d){c.set("WWW-Authenticate",'Basic realm="User Visible Realm"');c.status(401).send("Authorization header missing");
return}d=d.search(/basic /i);if(0!=d)return c.set("WWW-Authenticate",'Basic realm="User Visible Realm"'),Error(401,"basic authorization header needs to start with [basic base64 encoded acckey:clientkey]");case "accesskey":if("accesskey"===p.services[a].security&&(d=null,b.headers&&(d=b.headers.authorization),d||c.status(401).send("Authorization header missing"),d=d.search(/hmac /i),0!=d))return Error(401,"hmac authorization header needs hmac encoded string");e={req:b,res:c,next:e};d={body:{}};d.body.payload=
JSON.stringify({headers:b.headers,servicename:a});d.body.service="keymgr";d.body.method="post";d.body.routena="/grants/check";C(d,c,null,J,e);return}e()})}function E(a){if(p.services.hasOwnProperty("keymgr"))var b="/images/favicon.png",c="/imagesfavicon.png",d="https://www.purplecheer.io",e="PurpleCheerio";else c=b="/images/sample.png",d="/documentation",e="SampleService";p.about&&(p.about.faviconurl&&(b=p.about.faviconurl),p.about.imageurl&&(c=p.about.imageurl),p.about.url&&(d=p.about.url),p.about.name&&
(e=p.about.name));a=a.replace(/REPLFavIcon/g,b);return a.replace("REPLLogo",'<h1 style="background-color:#d8b2d880"><a href="'+d+'"><img src="'+c+'" style="height:32px" />'+e+"</a></h1>")}function I(c,d,e,h,f){var k=e?b.readFileSync(g("index.js")+"/templates/testform.html","utf8"):b.readFileSync(g("index.js")+"/templates/testrest.html","utf8");d.set("Content-Type","text/html");if(e){e="";var l=null;f&&(l=c.body.service);var u=p.services.hasOwnProperty("keymgr")?!0:!1;for(r in p.services){var z=p.services[r];
if(u){var m=a.resolve(g("index.js"),z.configfilepath);if(!b.existsSync(m)){console.log("service="+r+" not deployed configpath="+m+" does not exist");continue}}e+="<option class='btn-info form-control' ";l==r&&(e+="selected ");e+="value="+z.security+"@@@"+r;e+=">"+r+"</option>"}k=k.replace(/REPLservicelist/g,e);var r="";c.body.route&&(r="<input id='rname' type='text' style='display:none' value='"+c.body.route+"' /><input id='rtype' type='text' style='display:none' value='"+c.body.method+"' /><input id='rpayload' type='text' style='display:none' value='"+
c.body.payload+"' />");k=k.replace(/REPLRoute/,r)}f?(c='<h2 class="title">Response</h2>',200!=h&&(c+='<h6 style="color:#800000">status='+h+"</h4>"),f=c+"<pre>"+f+"</pre>"):f="";k=k.replace("REPLExtra",f);k=E(k);d.send(k)}function A(a,b,c){try{var d=JSON.parse(c)}catch(r){d={data:c}}a.res.headerSent||I(a.req,a.res,a.fService,b,JSON.stringify(d,0,2))}function C(a,b,c,d,e){c&&"object"===typeof c?c=c.services[a.body.service]:(c=g("index.js")+"/deploy/lib/serviceconfig.json",c=v.GetServiceConfig(c,a.body.service));
z&&z.dnsservicename&&"localhost"==c.hostname&&(c.hostname=a.body.service,console.log(c.hostname));var k={},h=null,f=null;switch(c.security){case "basic":case "accesskey":h={};h.security=c.security;h.nonce=R++;h.acckey=a.body.acckey;h.secret=a.body.secretna;break;case "appkey":f=a.body.appkey?v.MakeKeyServiceAndKeyValue(a.body.service,a.body.appkey):v.MakeKeyServiceAndKeyValue(a.body.service,c.key)}switch(a.body.method){case "post":try{""!==a.body.payload&&(k=JSON.parse(a.body.payload))}catch(P){b.json({error:"payload is not proper json"});
break}v.PostPutHttp("POST",h,f,c.protocol,c.hostname,a.body.routena,c.port,JSON.stringify(k),d,e);break;case "put":try{""!==a.body.payload&&(k=JSON.parse(a.body.payload))}catch(P){b.json({error:"payload is not proper json"});break}v.PostPutHttp("PUT",h,f,c.protocol,c.hostname,a.body.routena,c.port,JSON.stringify(k),d,e);break;case "static":case "get":v.GetHttpProper(h,f,c.protocol,c.hostname,a.body.routena,c.port,"",d,e);break;case "delete":v.DeleteHttp(h,f,c.protocol,c.hostname,a.body.routena,c.port,
"",d,e)}}function M(a,c){this.startservice(a,null,null,c)}function F(c,d,h,f){var k=null,l=g("index.js");d&&(k=require(a.resolve(d,h)),require(a.resolve(d,k.services[c].configfilepath)),l=d);h||(h="./deploy/lib/serviceconfig.json");e=d;this.initialize(c,k,f);k&&(p=k);this.setuproutes(l,p.services[c].configfilepath);d=p.services[c];var z=d.port;h=a.resolve(l,h);d.key=v.EstablishKey(h,c);d.certPath?(c=a.resolve(l,"./"+d.certPath+".key"),l=a.resolve(l,"./"+d.certPath+".crt"),l={key:b.readFileSync(c),
cert:b.readFileSync(l)},K.createServer(l,this).listen(z,function(){console.log("Securely listening on port "+z)})):this.listen(z,function(){console.log("Listening on port "+z)})}function L(c,b){b=require(a.resolve(c,b));for(var d in b.routes){var e=b.routes[d];if(e.configured){var h=a.resolve(c,e.routeclass);"static"===e.type?this.use(e.route,B.static(h)):(h=require(h),this[e.type](e.route,h[e.routefunction]))}}}var B=require("express"),G=require("body-parser"),p=require("./deploy/lib/serviceconfig.json"),
v=m(1,0),K=require("https"),b=require("fs"),a=require("path");require("util");m(2,0);var c=require("htmlencode").htmlEncode,e=null;try{var d=a.resolve(g("index.js"),"./lib/deploy.json");console.log(d);var h=b.readFileSync(d,"UTF8"),z=JSON.parse(h)}catch(k){"ENOENT"!=k.code&&console.log(k.code+" - "+k.message)}var R=17986;f=function(){var a=B.call(this)||this;a.initialize=O;a.startservice=F;a.startsystemservice=M;a.setuproutes=L;a.validatesecurekey=D;a.BodyValidate=w;return a};$jscomp.inherits(f,B);
f=new f;n.exports=f;return n.exports};n[1]=function(n,f){function q(b,a){b=A.createHmac("sha256",b);b.update(a);return b.digest("hex")}function y(b,a){var c=m(2,1);if(b.secret&&b.acckey){if("accesskey"===b.security){var e=new Date,d=b.acckey+":"+b.nonce;a.Authorization="hmac "+d+":"+c.Sign(b.secret,d+":"+e);a.Date=e;return}if("basic"===b.security){c=Buffer.from(b.acckey+":"+b.secret).toString("base64");a.Authorization="basic "+c;return}}b.Authorization?(a.Authorization=b.Authorization,c=a.Authorization.indexOf("hmac "),
0!=c?(c=a.Authorization.search(/basic /i),0!==c&&console.log("badly formed authorization string - needs to start with hmac")):(c=a.Authorization.slice(c+5),c.split(":"),a.Date=b.Date)):console.log("missing authorization string")}function w(b){if(!b)return null;var a="",c;for(c in b)"object"===typeof b[c]?(""!=a&&(a+="&"),a+=c+"="+JSON.stringify(b[c])):"array"!==typeof b[c]&&(""!=a&&(a+="&"),a+=c+"="+b[c]);return a}var H=require("http"),J=require("https"),D=require("fs"),E=require("path"),I=require("querystring"),
A=require("crypto"),C=require("jsonschema").Validator;f.Cipher=function(b,a){var c=A.randomBytes(16).toString("hex").slice(0,16),e=A.createHash("sha256").update(b).digest("hex");e=e.slice(0,32);a=A.createCipheriv("aes-256-ctr",e,c).update(a).toString("hex");b=q(b,a);return c+":::"+a+":::"+b};f.Decipher=function(b,a){var c=a.split(":::");a=c[0];var e=c[2],d=q(b,c[1]);if(e!=d)return null;c=new Buffer(c[1],"hex");b=A.createHash("sha256").update(b).digest("hex");b=b.slice(0,32);return A.createDecipheriv("aes-256-ctr",
b,a).update(c)};f.ValidateSchemaErrorObject=function(b,a){b=(new C).validate(b,a);if(b.errors.length){a="";for(var c in b.errors)a+=b.errors[c].stack+" ";return a}return null};f.ValidateSchema=function(b,a,c,e){return(b=this.ValidateSchemaErrorObject(b,a))?(e.status(422).json({errors:b}),!1):!0};f.BodyValidate=function(b,a,c,e){return c&&c.bodyschema?(e&&(c.bodyschema.definitions=c.bodyschema.definitions?Object.assign(c.bodyschema.definitions,e):e),this.ValidateSchema(b.body,c.bodyschema,b,a)):!0};
f.ParamValidate=function(b,a,c,e){if(c&&c.paramschema){var d=b.params[0],h=c.route;"/"==h.slice(0,1)&&(h=h.slice(1));"/"==d.slice(0,1)&&(d=d.slice(1));"/"==h.slice(-1)&&(h=h.slice(0,-1));"/"==d.slice(-1)&&(d=d.slice(0,-1));for(var f={};""!=h;){var g=!1;":"==h.slice(0,1)&&(g=!0,h=h.slice(1));var k=h.search("/"),m=d.search("/");if(0<=k){var l=h.slice(0,k);h=h.slice(k+1);var u=d.slice(0,m);d=d.slice(m+1)}else l=h.slice(0),h="",u=d.slice(0),d="";g&&(g=Number(u),isNaN(g)?f[l]=u:f[l]=g)}e&&(c.paramschema.definitions=
c.paramschema.definitions?Object.assign(c.paramschema.definitions,e):e);e=b.query;for(k in e)isNaN(e[k])||(e[k]=Number(e[k]));f=Object.assign({},f,e);return this.ValidateSchema(f,c.paramschema,b,a)}return!0};f.deep_value=function(b,a){a=a.split(".");for(var c in a)b=b[a[c]];return b};var M=require("os");f.GetIPFromService=function(b){var a=M.networkInterfaces(),c=null;b.networkname&&(c=b.networkname);b=null;for(var e in a){for(var d in a[e]){var h=a[e][d];"IPv4"!==h.family||h.internal||(b=h.address)}if(e==
c)break}return b};f.getFunctionsOfObject=function(b){return Object.getOwnPropertyNames(b).filter(function(a){return"function"==typeof b[a]})};f.MakeDir=function(b){var a=require("child_process").exec;a("mkdir  "+b)};f.WriteFile=function(b,a){try{return D.writeFileSync(b,a,"utf8"),!0}catch(c){return!1}};f.FormatYYYYMMDD=function(b){return b.getUTCFullYear()+"-"+("0"+(b.getUTCMonth()+1)).slice(-2)+"-"+("0"+b.getUTCDate()).slice(-2)};f.FormatYYYYMMDDHHMMSS=function(b){return this.FormatYYYYMMDD(b)+"-"+
("0"+b.getUTCHours()).slice(-2)+"-"+("0"+b.getUTCMinutes()).slice(-2)+"-"+("0"+b.getUTCSeconds()).slice(-2)};f.FormatYYYYMMDDHHMMSSColon=function(b){return this.FormatYYYYMMDD(b)+"T"+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)};f.Median=function(b){b.sort(function(a,c){return a-c});var a=b.length,c=Math.floor(a/2),e;1===a%2?e=b[c]:e=(b[c-1]+b[c])/2;return e};f.LowPassFilter=function(b,a,c){if(.1<Math.abs(a)){var e=(a-b)/b;e>c?a=b*(1+
c):e<c&&(a=b*(1-c))}return a};f.PostPutHttp=function(b,a,c,e,d,h,f,g,k,m){var l={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":g.length};c&&(l[c.keyName]=c.keyValue);if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)y(a,l),a=null;a=null}b={hostname:d,port:f,path:h,method:b,headers:l,json:!0};a&&(b.auth=a);a=H;if("https"==e||"https:"==e)b.rejectUnauthorized=!1,a=J;e=a.request(b,function(a){var c="";a.setEncoding("utf8");
a.on("data",function(a){c+=a});a.on("end",function(){200!=a.statusCode&&(console.log("Error statusCode="+a.statusCode),c&&console.log("data="+JSON.stringify(c)));k&&k(m,a.statusCode,c)})});e.on("error",function(a){console.log("problem with request: "+a.message);k&&k(m,500,a)});e.write(g);e.end()};f.PostHttpAuth=function(b,a,c,e,d,h,f,g,k){this.PostPutHttp("POST",b,a,c,e,d,h,f,g,k)};f.PostHttp=function(b,a,c,e,d,h,f,g){this.PostPutHttp("POST",null,b,a,c,e,d,h,f,g)};f.PutHttp=function(b,a,c,e,d,h,f,
g){this.PostPutHttp("PUT",null,b,a,c,e,d,h,f,g)};f.GetHttpAuth=function(b,a,c,e,d){b=H.request({hostname:b,port:c,path:a+"/"+e,method:"GET",headers:{"User-Agent":"app-bt/0.0.1","Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":e.length},json:!0},function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);d(a.statusCode,c)})});b.on("error",function(a){console.log("problem with request: "+
a.message)});b.end()};f.GetDeleteHttp=function(b,a,c,e,d,h,f,g,k,m){var l={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};c&&(l[c.keyName]=c.keyValue);if(a&&"object"===typeof a){if("accesskey"===a.security||"basic"===a.security)y(a,l),a=null;a=null}g&&(g=I.escape(g),h=h+"/?"+g);b={hostname:d,port:f,path:h,method:b,headers:l,json:!0};a&&(b.auth=a);a=H;if("https"==e||"https:"==e)b.rejectUnauthorized=!1,a=J;e=a.request(b,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=
a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);k(m,a.statusCode,c)})});e.on("error",function(a){console.log("problem with request: "+a.message)});e.end()};f.GetHttpProper=function(b,a,c,e,d,h,f,g,k){this.GetDeleteHttp("GET",b,a,c,e,d,h,f,g,k)};f.DeleteHttp=function(b,a,c,e,d,h,f,g,k){this.GetDeleteHttp("DELETE",b,a,c,e,d,h,f,g,k)};var F=0,L=require("url");try{var B=E.resolve(g("purpleskyutil.js"),"./lib/deploy.json"),G=D.readFileSync(B,"UTF8"),p=JSON.parse(G)}catch(b){"ENOENT"!=
b.code&&console.log(b.code+" - "+b.message)}f.RestTaskCall=function(b,a,c){var e=!1,d={};b.payload&&console.log("\t\tpayload ="+JSON.stringify(b.payload));var h=null;if(b.service&&b.servicepath){if(b.sysservice){if(!b.serviceconfig){d="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(d);a(c,404,JSON.stringify(d));return}var f=this.GetServiceConfig(b.serviceconfig,b.service)}else{if(!b.appserviceconfig){d="Parameter error: Task="+b.name+" does not contain appserviceconfig";
console.error(d);a(c,404,JSON.stringify(d));return}f=this.GetServiceConfig(b.appserviceconfig,b.service);if(!f){if(!b.serviceconfig){d="Parameter error: Task="+b.name+" does not contain serviceconfig";console.error(d);a(c,404,JSON.stringify(d));return}f=this.GetServiceConfig(b.serviceconfig,b.service)}}if(!(f&&"object"==typeof f&&f.hasOwnProperty("protocol")&&f.hasOwnProperty("hostname")&&f.hasOwnProperty("port"))){d="Parameter error: Task="+b.name+" has unrecognized service="+b.service+" sc="+JSON.stringify(f);
console.error(d);a(c,404,JSON.stringify(d));return}p&&p.dnsservicename&&"localhost"==f.hostname&&(f.hostname=b.service);e=!0;d.protocol=f.protocol;d.hostname=f.hostname;d.port=f.port;switch(f.security){case "basic":case "accesskey":h={};h.security=f.security;h.nonce=F++;h.acckey=b.acckey;h.secret=b.secretna;break;case "appkey":d.key=b.appkey?this.MakeKeyServiceAndKeyValue(b.service,b.appkey):this.MakeKeyServiceAndKeyValue(b.service,f.key)}d.pathname=b.servicepath;0!=d.pathname.search("/")&&(d.pathname=
"/"+d.pathname)}if(b.url||e)switch(e=null,b.payload&&(e=b.payload),b.url&&(d=L.parse(b.url),d.key=null),b.method){case "POST":b="";e&&(b=JSON.stringify(e));this.PostPutHttp("POST",h,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;case "PUT":b="";e&&(b=JSON.stringify(e));this.PostPutHttp("PUT",h,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;case "GET":b="";e&&(b=w(e));this.GetHttpProper(h,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;case "DELETE":b="";e&&(b=w(e));
this.DeleteHttp(h,d.key,d.protocol,d.hostname,d.pathname,d.port,b,a,c);break;default:d=b.hasOwnProperty("name")?"Parameter error: Task="+b.name+" has unrecognized method="+b.method:"Parameter error: unrecognized method="+b.method,console.error(d),a(c,404,{error:d})}else b.func?(b.payload&&JSON.parse(JSON.stringify(b.payload)),d=eval("this.to."+b.func+"(payload)"),a(c,200,d)):a(c,200,{})};f.ServiceKeyName=function(b){return b+"-api-key"};f.MakeKeyServiceAndKeyValue=function(b,a){if(!a)return null;
var c={};c.keyName=this.ServiceKeyName(b);c.keyValue=a;return c};f.EstablishKey=function(b,a){var c=D.readFileSync(b,"utf8");c=JSON.parse(c);var e=c.services;if(!e||!e[a]||"appkey"!==e[a].security)return null;e[a].key||(e[a].key=this.GenerateKeyFromDate((new Date).toString()),D.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return e[a].key};f.GenerateKeyFromDate=function(b){return A.createHash("md5").update(b).digest("hex")};f.GetServiceConfig=function(b,a){var c=D.readFileSync(b,"utf8");c=JSON.parse(c);
if(!c)return null;var e=c.services;if(!e||!e[a])return null;c=e[a];e[a].security||(e[a].security="nokey",D.writeFileSync(b,JSON.stringify(c,0,2),"UTF8"));return e[a]};f.PriorityQueue=function(b){this._comparator=b||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=function(a,c){if("number"===typeof a&&"number"===typeof c)return a-c;a=a.toString();c=c.toString();return a==c?0:a>c?1:-1};f.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");
return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(a){a=this._elements.push(a);for(var c=a-1;0<c;){var b=c-1;if(0>=this._compare(c,b))break;this._swap(b,c);c=b}return a};this.size=function(){return this._elements.length};this.getElement=function(a){return 0>a||a>=this.size()?null:this._elements[a]};this.getElements=function(a){return this._elements};this.forEach=function(a){return this._elements.forEach(a)};this._compare=function(a,
c){return this._comparator(this._elements[a],this._elements[c])};this._swap=function(a,c){var b=this._elements[a];this._elements[a]=this._elements[c];this._elements[c]=b}};var v=require("cacheman");f.TtlCache=function(b,a,c){if(!b)return null;if(a||c){var e={};a&&(e.ttl=a);c&&(e.engine=c);this.cache=new v(b,e)}else this.cache=new v(b);this.Set=function(a,c,b){this.cache.set(a,c,b)};this.Get=function(a,c){this.cache.get(a,c)}};var K=require("dgram");f.Udp=function(b,a,c,e){this.server=K.createSocket("udp4");
b||a?(this.server.bind({address:c,port:e}),this.server.on("listen",b),this.server.on("message",a),this.broadcastMode=!1):this.broadcastMode=!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};this.broadcast=function(a,c,b){if(this.broadcastMode){var d=new Buffer(JSON.stringify(b));this.server.send(d,0,d.length,c,a,function(){console.log("Sent '"+d+"'")})}}};return n.exports};n[2]=function(q,f){function n(a){var c=JSON.stringify(b);
c=C.Cipher(p,c);v.writeFileSync(a,c)}function y(a,c){return{status:a,error:c}}function w(a){for(var c in b){var e=b[c];if(e.acckey==a)return e}return null}function H(a){a=w(a);if(!a)return null;a=JSON.parse(JSON.stringify(a));delete a.secret;return a}function J(a){var c=a.authorization;if(!c)return y("403","Authorization header missing");if(0!=c.search(/hmac /i)){if(c=a.authorization)if(0!=c.search(/basic /i))c=y(403,"basic authorization header needs to start with hmac");else{c=c.slice(6);c=Buffer.from(c,
"base64").toString().split(":");var b=c[0];c=(a=w(b))?c[1]===a.secret?a:y(403,"could not authenticate"):y(403,"acckey="+b+" not found")}else c=y("403","Authorization header missing");return c}b=c.slice(5).split(":");var d=b[0];c=w(d);if(!c)return y(403,"acckey="+d+" not found");a=a.date;d=b.splice(-1,1)[0];b=b.join(":");return A(c.secret,b+(":"+a))==d?c:y(403,"could not authenticate")}function D(a){var c=C.GetServiceConfig(L,a);return c?c:c=C.GetServiceConfig(B,a)}function E(a,c){var b=w(a);if(!b)return y(403,
"acckey invalid");var d=D(c);if(!d)return y(404,"No such service="+c);if("accesskey"!==d.security&&"basic"!==d.security)return y(403,"access is forbidden to service="+c);c&&0>b.services.indexOf(c)&&b.services.push(c);n(F);return H(a)}function I(a,c){var b=w(a);if(!b)return y(403,"acckey invalid");var d=D(c);if("accesskey"!==d.security&&"basic"!==d.security)return y(403,"access is forbidden");d=b.services.indexOf(c);if(0>d)return y(403,"no access to service="+c);b.services.splice(d,1);n(F);return H(a)}
function A(a,c){a=M.createHmac("sha256",a);a.update(c);return a.digest("hex")}var C=m(1,2),M=require("crypto"),F="./deploy/lib/aclconfig.json",L=g("apikeymgr.js")+"/deploy/lib/serviceconfig.json",B=L,G=g("apikeymgr.js"),p="secretkey",v=require("fs"),K=require("path"),b={};f.initialize=function(a){var c=F;a&&(G=a.appdir,c=a.aclconfig,B=K.resolve(G,a.appserviceconfig),p=a.secret);F=c=K.resolve(G,c);b=null;v.existsSync(c)&&(a=v.readFileSync(c,"utf8"),(a=C.Decipher(p,a))?(a=a.toString("UTF8"),b=JSON.parse(a)):
b=null);b||(b={},n(c))};f.Sign=function(a,c){return A(a,c)};f.RouteAllocateAccessKeys=function(a,c){a=a.params.clientid;var e=(new Date).valueOf(),d=Math.round(Math.random()*e),f=C.GenerateKeyFromDate(d.toString());d=Math.round(Math.random()*e);e=C.GenerateKeyFromDate(d.toString());d=[];b[a]||(b[a]={});b[a].acckey=f;b[a].secret=e;b[a].services=[];for(g in d)servicename&&0>b[a].services.indexOf(d[g])&&b[a].services.push(d[g]);n(F);var g=w(f);c.status(200).json(g)};f.RouteGetClientFromClientid=function(a,
c){a=a.params.clientid;a=b[a]?JSON.parse(JSON.stringify(b[a])):null;null==a?c.status(401).json({error:"client does not have accesskeys"}):c.status(200).json(a)};f.RouteGetClientFromAcckey=function(a,c){a=w(a.params.acckey);null==a?c.status(401).json({error:"client does not have accesskeys"}):c.status(200).json(a)};f.RouteRevokeClient=function(a,c){a=a.params.clientid;b[a]?(delete b[a],a=!0):a=!1;a?c.status(200).json({data:"OK"}):c.status(401).json({error:"client does not have accesskeys"})};f.RouteGrantAccess=
function(a,c){a=E(a.params.acckey,a.params.servicename);a.error?c.status(a.status).json({error:a.error}):c.status(200).json(a)};f.RouteRevokeAccess=function(a,c){a=I(a.params.acckey,a.params.servicename);a.error?c.status(a.status).json({error:a.error}):c.status(200).json(a)};f.RouteGetAccessServices=function(a,c){a=H(a.params.acckey);if(!a)return y(403,"acckey invalid");c.status(200).json(a.services)};f.RouteGetAccessOneService=function(a,c){var b=a.params.servicename;b=(a=H(a.params.acckey))?0>a.services.indexOf(b)?
y(404,"access was never granted to client="+a.clientid+" for service="+b):b:y(403,"acckey invalid");b.error?c.status(b.status).json({error:b.error}):c.status(200).json(b)};f.CheckServiceAccess=function(a,c,b){a=J(a.headers);return a.error?a:0>a.services.indexOf(b)?y(404,"access was never granted to client="+a.clientid+" for service="+b):b};f.RouteCheckAccessOneService=function(a,b){var c=J(a.body.headers);c.error?b.status(403).send({error:"not autherized"}):0>c.services.indexOf(a.body.servicename)?
b.status(404).json({error:"access was never granted to client="+c.clientid+" for service="+servicename}):b.status(200).json({servicename:a.body.servicename})};return q.exports};if("object"===typeof module)module.exports=m(0);else return m(0)})();
