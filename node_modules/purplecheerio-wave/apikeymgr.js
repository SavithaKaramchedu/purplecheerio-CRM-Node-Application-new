var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.owns=function(g,p){return Object.prototype.hasOwnProperty.call(g,p)};$jscomp.assign="function"==typeof Object.assign?Object.assign:function(g,p){for(var h=1;h<arguments.length;h++){var k=arguments[h];if(k)for(var m in k)$jscomp.owns(k,m)&&(g[m]=k[m])}return g};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(g,p,h){g!=Array.prototype&&g!=Object.prototype&&(g[p]=h.value)};$jscomp.getGlobal=function(g){return"undefined"!=typeof window&&window===g?g:"undefined"!=typeof global&&null!=global?global:g};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(g,p,h,k){if(p){h=$jscomp.global;g=g.split(".");for(k=0;k<g.length-1;k++){var m=g[k];m in h||(h[m]={});h=h[m]}g=g[g.length-1];k=h[g];p=p(k);p!=k&&null!=p&&$jscomp.defineProperty(h,g,{configurable:!0,writable:!0,value:p})}};$jscomp.polyfill("Object.assign",function(g){return g||$jscomp.assign},"es6","es3");
(function(){function g(g,f){m[g]||(k[g]={exports:{},loaded:!1},m[g]=!0,0===g&&"function"===typeof require?require.main=k[0]:k[g].parent=k[f],h[g].call(this,k[g],k[g].exports),k[g].loaded=!0);return k[g].exports}function p(g){return require("path").resolve(__dirname+"/"+g+"/../")}var h={},k={},m={};h[0]=function(k,f){function h(b){var c=JSON.stringify(a);c=t.Cipher(w,c);x.writeFileSync(b,c)}function n(b,a){return{status:b,error:a}}function m(b){for(var c in a){var d=a[c];if(d.acckey==b)return d}return null}
function u(b){b=m(b);if(!b)return null;b=JSON.parse(JSON.stringify(b));delete b.secret;return b}function y(b){var a=b.authorization;if(!a)return n("403","Authorization header missing");if(0!=a.search(/hmac /i)){if(a=b.authorization)if(0!=a.search(/basic /i))a=n(403,"basic authorization header needs to start with hmac");else{a=a.slice(6);a=Buffer.from(a,"base64").toString().split(":");var d=a[0];a=(b=m(d))?a[1]===b.secret?b:n(403,"could not authenticate"):n(403,"acckey="+d+" not found")}else a=n("403",
"Authorization header missing");return a}d=a.slice(5).split(":");var e=d[0];a=m(e);if(!a)return n(403,"acckey="+e+" not found");b=b.date;e=d.splice(-1,1)[0];d=d.join(":");return q(a.secret,d+(":"+b))==e?a:n(403,"could not authenticate")}function r(b){var a=t.GetServiceConfig(A,b);return a?a:a=t.GetServiceConfig(B,b)}function D(b,a){var c=m(b);if(!c)return n(403,"acckey invalid");var e=r(a);if(!e)return n(404,"No such service="+a);if("accesskey"!==e.security&&"basic"!==e.security)return n(403,"access is forbidden to service="+
a);a&&0>c.services.indexOf(a)&&c.services.push(a);h(v);return u(b)}function E(b,a){var c=m(b);if(!c)return n(403,"acckey invalid");var e=r(a);if("accesskey"!==e.security&&"basic"!==e.security)return n(403,"access is forbidden");e=c.services.indexOf(a);if(0>e)return n(403,"no access to service="+a);c.services.splice(e,1);h(v);return u(b)}function q(b,a){b=F.createHmac("sha256",b);b.update(a);return b.digest("hex")}var t=g(1,0),F=require("crypto"),v="./deploy/lib/aclconfig.json",A=p("apikeymgr.js")+
"/deploy/lib/serviceconfig.json",B=A,z=p("apikeymgr.js"),w="secretkey",x=require("fs"),C=require("path"),a={};f.initialize=function(b){var c=v;b&&(z=b.appdir,c=b.aclconfig,B=C.resolve(z,b.appserviceconfig),w=b.secret);v=c=C.resolve(z,c);a=null;x.existsSync(c)&&(b=x.readFileSync(c,"utf8"),(b=t.Decipher(w,b))?(b=b.toString("UTF8"),a=JSON.parse(b)):a=null);a||(a={},h(c))};f.Sign=function(b,a){return q(b,a)};f.RouteAllocateAccessKeys=function(b,c){b=b.params.clientid;var d=(new Date).valueOf(),e=Math.round(Math.random()*
d),l=t.GenerateKeyFromDate(e.toString());e=Math.round(Math.random()*d);d=t.GenerateKeyFromDate(e.toString());e=[];a[b]||(a[b]={});a[b].acckey=l;a[b].secret=d;a[b].services=[];for(f in e)servicename&&0>a[b].services.indexOf(e[f])&&a[b].services.push(e[f]);h(v);var f=m(l);c.status(200).json(f)};f.RouteGetClientFromClientid=function(b,c){b=b.params.clientid;b=a[b]?JSON.parse(JSON.stringify(a[b])):null;null==b?c.status(401).json({error:"client does not have accesskeys"}):c.status(200).json(b)};f.RouteGetClientFromAcckey=
function(b,a){b=m(b.params.acckey);null==b?a.status(401).json({error:"client does not have accesskeys"}):a.status(200).json(b)};f.RouteRevokeClient=function(b,c){b=b.params.clientid;a[b]?(delete a[b],b=!0):b=!1;b?c.status(200).json({data:"OK"}):c.status(401).json({error:"client does not have accesskeys"})};f.RouteGrantAccess=function(b,a){b=D(b.params.acckey,b.params.servicename);b.error?a.status(b.status).json({error:b.error}):a.status(200).json(b)};f.RouteRevokeAccess=function(b,a){b=E(b.params.acckey,
b.params.servicename);b.error?a.status(b.status).json({error:b.error}):a.status(200).json(b)};f.RouteGetAccessServices=function(b,a){b=u(b.params.acckey);if(!b)return n(403,"acckey invalid");a.status(200).json(b.services)};f.RouteGetAccessOneService=function(b,a){var c=b.params.servicename;c=(b=u(b.params.acckey))?0>b.services.indexOf(c)?n(404,"access was never granted to client="+b.clientid+" for service="+c):c:n(403,"acckey invalid");c.error?a.status(c.status).json({error:c.error}):a.status(200).json(c)};
f.CheckServiceAccess=function(b,a,d){b=y(b.headers);return b.error?b:0>b.services.indexOf(d)?n(404,"access was never granted to client="+b.clientid+" for service="+d):d};f.RouteCheckAccessOneService=function(b,a){var c=y(b.body.headers);c.error?a.status(403).send({error:"not autherized"}):0>c.services.indexOf(b.body.servicename)?a.status(404).json({error:"access was never granted to client="+c.clientid+" for service="+servicename}):a.status(200).json({servicename:b.body.servicename})};return k.exports};
h[1]=function(k,f){function h(a,b){a=q.createHmac("sha256",a);a.update(b);return a.digest("hex")}function n(a,b){var c=g(0,1);if(a.secret&&a.acckey){if("accesskey"===a.security){var d=new Date,e=a.acckey+":"+a.nonce;b.Authorization="hmac "+e+":"+c.Sign(a.secret,e+":"+d);b.Date=d;return}if("basic"===a.security){c=Buffer.from(a.acckey+":"+a.secret).toString("base64");b.Authorization="basic "+c;return}}a.Authorization?(b.Authorization=a.Authorization,c=b.Authorization.indexOf("hmac "),0!=c?(c=b.Authorization.search(/basic /i),
0!==c&&console.log("badly formed authorization string - needs to start with hmac")):(c=b.Authorization.slice(c+5),c.split(":"),b.Date=a.Date)):console.log("missing authorization string")}function m(a){if(!a)return null;var b="",c;for(c in a)"object"===typeof a[c]?(""!=b&&(b+="&"),b+=c+"="+JSON.stringify(a[c])):"array"!==typeof a[c]&&(""!=b&&(b+="&"),b+=c+"="+a[c]);return b}var u=require("http"),y=require("https"),r=require("fs"),D=require("path"),E=require("querystring"),q=require("crypto"),t=require("jsonschema").Validator;
f.Cipher=function(a,b){var c=q.randomBytes(16).toString("hex").slice(0,16),d=q.createHash("sha256").update(a).digest("hex");d=d.slice(0,32);b=q.createCipheriv("aes-256-ctr",d,c).update(b).toString("hex");a=h(a,b);return c+":::"+b+":::"+a};f.Decipher=function(a,b){var c=b.split(":::");b=c[0];var d=c[2],e=h(a,c[1]);if(d!=e)return null;c=new Buffer(c[1],"hex");a=q.createHash("sha256").update(a).digest("hex");a=a.slice(0,32);return q.createDecipheriv("aes-256-ctr",a,b).update(c)};f.ValidateSchemaErrorObject=
function(a,b){a=(new t).validate(a,b);if(a.errors.length){b="";for(var c in a.errors)b+=a.errors[c].stack+" ";return b}return null};f.ValidateSchema=function(a,b,c,d){return(a=this.ValidateSchemaErrorObject(a,b))?(d.status(422).json({errors:a}),!1):!0};f.BodyValidate=function(a,b,c,d){return c&&c.bodyschema?(d&&(c.bodyschema.definitions=c.bodyschema.definitions?Object.assign(c.bodyschema.definitions,d):d),this.ValidateSchema(a.body,c.bodyschema,a,b)):!0};f.ParamValidate=function(a,b,c,d){if(c&&c.paramschema){var e=
a.params[0],l=c.route;"/"==l.slice(0,1)&&(l=l.slice(1));"/"==e.slice(0,1)&&(e=e.slice(1));"/"==l.slice(-1)&&(l=l.slice(0,-1));"/"==e.slice(-1)&&(e=e.slice(0,-1));for(var f={};""!=l;){var g=!1;":"==l.slice(0,1)&&(g=!0,l=l.slice(1));var h=l.search("/"),k=e.search("/");if(0<=h){var m=l.slice(0,h);l=l.slice(h+1);var H=e.slice(0,k);e=e.slice(k+1)}else m=l.slice(0),l="",H=e.slice(0),e="";g&&(g=Number(H),isNaN(g)?f[m]=H:f[m]=g)}d&&(c.paramschema.definitions=c.paramschema.definitions?Object.assign(c.paramschema.definitions,
d):d);d=a.query;for(h in d)isNaN(d[h])||(d[h]=Number(d[h]));f=Object.assign({},f,d);return this.ValidateSchema(f,c.paramschema,a,b)}return!0};f.deep_value=function(a,b){b=b.split(".");for(var c in b)a=a[b[c]];return a};var F=require("os");f.GetIPFromService=function(a){var b=F.networkInterfaces(),c=null;a.networkname&&(c=a.networkname);a=null;for(var d in b){for(var e in b[d]){var l=b[d][e];"IPv4"!==l.family||l.internal||(a=l.address)}if(d==c)break}return a};f.getFunctionsOfObject=function(a){return Object.getOwnPropertyNames(a).filter(function(b){return"function"==
typeof a[b]})};f.MakeDir=function(a){var b=require("child_process").exec;b("mkdir  "+a)};f.WriteFile=function(a,b){try{return r.writeFileSync(a,b,"utf8"),!0}catch(c){return!1}};f.FormatYYYYMMDD=function(a){return a.getUTCFullYear()+"-"+("0"+(a.getUTCMonth()+1)).slice(-2)+"-"+("0"+a.getUTCDate()).slice(-2)};f.FormatYYYYMMDDHHMMSS=function(a){return this.FormatYYYYMMDD(a)+"-"+("0"+a.getUTCHours()).slice(-2)+"-"+("0"+a.getUTCMinutes()).slice(-2)+"-"+("0"+a.getUTCSeconds()).slice(-2)};f.FormatYYYYMMDDHHMMSSColon=
function(a){return this.FormatYYYYMMDD(a)+"T"+("0"+a.getUTCHours()).slice(-2)+":"+("0"+a.getUTCMinutes()).slice(-2)+":"+("0"+a.getUTCSeconds()).slice(-2)};f.Median=function(a){a.sort(function(a,b){return a-b});var b=a.length,c=Math.floor(b/2),d;1===b%2?d=a[c]:d=(a[c-1]+a[c])/2;return d};f.LowPassFilter=function(a,b,c){if(.1<Math.abs(b)){var d=(b-a)/a;d>c?b=a*(1+c):d<c&&(b=a*(1-c))}return b};f.PostPutHttp=function(a,b,c,d,e,l,f,g,h,k){var G={"User-Agent":"app-bt/0.0.1","Content-Type":"application/json",
"Cache-Control":"no-cache","Content-Length":g.length};c&&(G[c.keyName]=c.keyValue);if(b&&"object"===typeof b){if("accesskey"===b.security||"basic"===b.security)n(b,G),b=null;b=null}a={hostname:e,port:f,path:l,method:a,headers:G,json:!0};b&&(a.auth=b);b=u;if("https"==d||"https:"==d)a.rejectUnauthorized=!1,b=y;d=b.request(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&(console.log("Error statusCode="+a.statusCode),b&&console.log("data="+
JSON.stringify(b)));h&&h(k,a.statusCode,b)})});d.on("error",function(a){console.log("problem with request: "+a.message);h&&h(k,500,a)});d.write(g);d.end()};f.PostHttpAuth=function(a,b,c,d,e,l,f,g,h){this.PostPutHttp("POST",a,b,c,d,e,l,f,g,h)};f.PostHttp=function(a,b,c,d,e,f,g,h){this.PostPutHttp("POST",null,a,b,c,d,e,f,g,h)};f.PutHttp=function(a,b,c,d,e,f,g,h){this.PostPutHttp("PUT",null,a,b,c,d,e,f,g,h)};f.GetHttpAuth=function(a,b,c,d,e){a=u.request({hostname:a,port:c,path:b+"/"+d,method:"GET",headers:{"User-Agent":"app-bt/0.0.1",
"Content-Type":"application/json","Cache-Control":"no-cache","Content-Length":d.length},json:!0},function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);e(a.statusCode,b)})});a.on("error",function(a){console.log("problem with request: "+a.message)});a.end()};f.GetDeleteHttp=function(a,b,c,d,e,f,g,h,k,m){var l={"User-Agent":"app-bt/0.0.1","Cache-Control":"no-cache"};c&&(l[c.keyName]=c.keyValue);
if(b&&"object"===typeof b){if("accesskey"===b.security||"basic"===b.security)n(b,l),b=null;b=null}h&&(h=E.escape(h),f=f+"/?"+h);a={hostname:e,port:g,path:f,method:a,headers:l,json:!0};b&&(a.auth=b);b=u;if("https"==d||"https:"==d)a.rejectUnauthorized=!1,b=y;d=b.request(a,function(a){var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){200!=a.statusCode&&console.log("Error statusCode="+a.statusCode);k(m,a.statusCode,b)})});d.on("error",function(a){console.log("problem with request: "+
a.message)});d.end()};f.GetHttpProper=function(a,b,c,d,e,f,g,h,k){this.GetDeleteHttp("GET",a,b,c,d,e,f,g,h,k)};f.DeleteHttp=function(a,b,c,d,e,f,g,h,k){this.GetDeleteHttp("DELETE",a,b,c,d,e,f,g,h,k)};var v=0,A=require("url");try{var B=D.resolve(p("purpleskyutil.js"),"./lib/deploy.json"),z=r.readFileSync(B,"UTF8"),w=JSON.parse(z)}catch(a){"ENOENT"!=a.code&&console.log(a.code+" - "+a.message)}f.RestTaskCall=function(a,b,c){var d=!1,e={};a.payload&&console.log("\t\tpayload ="+JSON.stringify(a.payload));
var f=null;if(a.service&&a.servicepath){if(a.sysservice){if(!a.serviceconfig){e="Parameter error: Task="+a.name+" does not contain serviceconfig";console.error(e);b(c,404,JSON.stringify(e));return}var g=this.GetServiceConfig(a.serviceconfig,a.service)}else{if(!a.appserviceconfig){e="Parameter error: Task="+a.name+" does not contain appserviceconfig";console.error(e);b(c,404,JSON.stringify(e));return}g=this.GetServiceConfig(a.appserviceconfig,a.service);if(!g){if(!a.serviceconfig){e="Parameter error: Task="+
a.name+" does not contain serviceconfig";console.error(e);b(c,404,JSON.stringify(e));return}g=this.GetServiceConfig(a.serviceconfig,a.service)}}if(!(g&&"object"==typeof g&&g.hasOwnProperty("protocol")&&g.hasOwnProperty("hostname")&&g.hasOwnProperty("port"))){e="Parameter error: Task="+a.name+" has unrecognized service="+a.service+" sc="+JSON.stringify(g);console.error(e);b(c,404,JSON.stringify(e));return}w&&w.dnsservicename&&"localhost"==g.hostname&&(g.hostname=a.service);d=!0;e.protocol=g.protocol;
e.hostname=g.hostname;e.port=g.port;switch(g.security){case "basic":case "accesskey":f={};f.security=g.security;f.nonce=v++;f.acckey=a.acckey;f.secret=a.secretna;break;case "appkey":e.key=a.appkey?this.MakeKeyServiceAndKeyValue(a.service,a.appkey):this.MakeKeyServiceAndKeyValue(a.service,g.key)}e.pathname=a.servicepath;0!=e.pathname.search("/")&&(e.pathname="/"+e.pathname)}if(a.url||d)switch(d=null,a.payload&&(d=a.payload),a.url&&(e=A.parse(a.url),e.key=null),a.method){case "POST":a="";d&&(a=JSON.stringify(d));
this.PostPutHttp("POST",f,e.key,e.protocol,e.hostname,e.pathname,e.port,a,b,c);break;case "PUT":a="";d&&(a=JSON.stringify(d));this.PostPutHttp("PUT",f,e.key,e.protocol,e.hostname,e.pathname,e.port,a,b,c);break;case "GET":a="";d&&(a=m(d));this.GetHttpProper(f,e.key,e.protocol,e.hostname,e.pathname,e.port,a,b,c);break;case "DELETE":a="";d&&(a=m(d));this.DeleteHttp(f,e.key,e.protocol,e.hostname,e.pathname,e.port,a,b,c);break;default:e=a.hasOwnProperty("name")?"Parameter error: Task="+a.name+" has unrecognized method="+
a.method:"Parameter error: unrecognized method="+a.method,console.error(e),b(c,404,{error:e})}else a.func?(a.payload&&JSON.parse(JSON.stringify(a.payload)),e=eval("this.to."+a.func+"(payload)"),b(c,200,e)):b(c,200,{})};f.ServiceKeyName=function(a){return a+"-api-key"};f.MakeKeyServiceAndKeyValue=function(a,b){if(!b)return null;var c={};c.keyName=this.ServiceKeyName(a);c.keyValue=b;return c};f.EstablishKey=function(a,b){var c=r.readFileSync(a,"utf8");c=JSON.parse(c);var d=c.services;if(!d||!d[b]||
"appkey"!==d[b].security)return null;d[b].key||(d[b].key=this.GenerateKeyFromDate((new Date).toString()),r.writeFileSync(a,JSON.stringify(c,0,2),"UTF8"));return d[b].key};f.GenerateKeyFromDate=function(a){return q.createHash("md5").update(a).digest("hex")};f.GetServiceConfig=function(a,b){var c=r.readFileSync(a,"utf8");c=JSON.parse(c);if(!c)return null;var d=c.services;if(!d||!d[b])return null;c=d[b];d[b].security||(d[b].security="nokey",r.writeFileSync(a,JSON.stringify(c,0,2),"UTF8"));return d[b]};
f.PriorityQueue=function(a){this._comparator=a||this.DEFAULT_COMPARATOR;this._elements=[];this.DEFAULT_COMPARATOR=function(a,c){if("number"===typeof a&&"number"===typeof c)return a-c;a=a.toString();c=c.toString();return a==c?0:a>c?1:-1};f.PriorityQueue.isEmpty=function(){return 0===this.size()};this.peek=function(){if(this.isEmpty())throw Error("PriorityQueue is empty");return this._elements[0]};this.deq=function(){return this._elements.length?this._elements.shift():null};this.enq=function(a){a=this._elements.push(a);
for(var b=a-1;0<b;){var d=b-1;if(0>=this._compare(b,d))break;this._swap(d,b);b=d}return a};this.size=function(){return this._elements.length};this.getElement=function(a){return 0>a||a>=this.size()?null:this._elements[a]};this.getElements=function(a){return this._elements};this.forEach=function(a){return this._elements.forEach(a)};this._compare=function(a,c){return this._comparator(this._elements[a],this._elements[c])};this._swap=function(a,c){var b=this._elements[a];this._elements[a]=this._elements[c];
this._elements[c]=b}};var x=require("cacheman");f.TtlCache=function(a,b,c){if(!a)return null;if(b||c){var d={};b&&(d.ttl=b);c&&(d.engine=c);this.cache=new x(a,d)}else this.cache=new x(a);this.Set=function(a,b,c){this.cache.set(a,b,c)};this.Get=function(a,b){this.cache.get(a,b)}};var C=require("dgram");f.Udp=function(a,b,c,d){this.server=C.createSocket("udp4");a||b?(this.server.bind({address:c,port:d}),this.server.on("listen",a),this.server.on("message",b),this.broadcastMode=!1):this.broadcastMode=
!0;this.address=function(){return this.server.address().address};this.port=function(){return this.server.address().port};this.broadcast=function(a,b,c){if(this.broadcastMode){var d=new Buffer(JSON.stringify(c));this.server.send(d,0,d.length,b,a,function(){console.log("Sent '"+d+"'")})}}};return k.exports};if("object"===typeof module)module.exports=g(0);else return g(0)})();
